<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sports Scores Ticker (PST, Broadcast Grade)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
  font-family: Arial, Helvetica, sans-serif;
}

/* Ticker container */
.ticker-wrap {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 80px;
  background: rgba(0,0,0,0.35);
  display: flex;
  align-items: center;
  overflow: hidden;
  transition: opacity 0.8s ease;
  padding-left: 12px;
  box-sizing: border-box;
}

.ticker-wrap.hidden {
  opacity: 0;
  pointer-events: none;
}

.ticker {
  white-space: nowrap;
  padding-left: 100%;
  font-size: 28px; /* original size */
  color: white;
  opacity: 0;
}

.scroll {
  animation:
    fadeIn 1.5s ease forwards,
    scroll 70s linear forwards,
    fadeOut 1.5s ease forwards;
  animation-delay: 0s, 0s, 68.5s;
}

@keyframes scroll {
  from { transform: translateX(0); }
  to { transform: translateX(-100%); }
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

/* LIVE badge */
.live {
  color: #00ff7f;
  font-weight: bold;
  animation: livePulse 1.6s infinite;
}

@keyframes livePulse {
  0% { text-shadow: 0 0 0 rgba(0,255,127,0); }
  50% { text-shadow: 0 0 8px rgba(0,255,127,0.35); }
  100% { text-shadow: 0 0 0 rgba(0,255,127,0); }
}

/* Retro ESPN/FOX-style wide premium separator */
.separator {
  display: inline-block;
  width: 12px;
  height: 60px; /* matches pill height */
  margin: 0 26px;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.35));
  border-radius: 6px;
  box-shadow:
    0 6px 18px rgba(0,0,0,0.55),
    0 0 14px rgba(255,255,255,0.18) inset;
  vertical-align: middle;
  transform: translateY(2px);
}

/* Team logos (15% larger) */
.team-logo {
  height: 22px;
  transform: scale(1.15);
  transform-origin: center;
  display: inline-block;
  vertical-align: middle;
  margin-right: 6px;
}
.team-logo.right {
  margin-left: 6px;
  margin-right: 0;
}

/* GAME PILL — 28px text, matched height */
.game-pill {
  padding: 10px 16px;
  border-radius: 10px;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  color: #fff;
  font-size: 28px; /* match original */
  min-height: 60px; /* matches separator */
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  line-height: 1;
}

/* ROUND PILL — same size as game pill */
.round-pill {
  padding: 10px 16px;
  border-radius: 10px;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  font-size: 28px; /* match game pill */
  font-weight: 700;
  color: #fff;
  min-height: 60px;
  margin: 0 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}

/* Round emblem — scaled to match logos */
.round-pill .round-icon {
  width: 36px;
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  flex: 0 0 36px;
  background: rgba(255,255,255,0.12);
  box-shadow: inset 0 -2px 6px rgba(0,0,0,0.25);
}

/* Round color themes */
.round-wildcard { background: linear-gradient(135deg,#2b8cff,#1a6bff); }
.round-divisional { background: linear-gradient(135deg,#ff7a2b,#ff4b1a); }
.round-conference { background: linear-gradient(135deg,#7b2bff,#4b1aff); }
.round-super { background: linear-gradient(135deg,#ffd700,#ffb400); }

img.team-logo { object-fit: contain; }
</style>
</head>

<body>
<div class="ticker-wrap" id="tickerWrap">
  <div class="ticker" id="ticker">Loading…</div>
</div>

<script>
/* CONFIG */
const PAUSE_BETWEEN_LOOPS = 3000;
const leagues = [
  { name: "NFL", url: "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard" },
  { name: "NBA", url: "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard" },
  { name: "MLB", url: "https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard" },
  { name: "NHL", url: "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard" }
];
const leagueColors = {
  NFL: "#013369",
  NBA: "#17408B",
  MLB: "#002D72",
  NHL: "#111111"
};

/* HELPERS */
function safe(o, p, f = "") {
  try {
    return p.split(".").reduce((x, k) => (x && x[k] !== undefined ? x[k] : undefined), o) ?? f;
  } catch {
    return f;
  }
}

/* FORCE PACIFIC TIME (A1: real PST from ESPN UTC) */
function pstTimestamp(input) {
  try {
    const iso = typeof input === "string" ? input : new Date(input).toISOString();
    return new Date(
      new Date(iso).toLocaleString("en-US", { timeZone: "America/Los_Angeles" })
    ).getTime();
  } catch {
    return 0;
  }
}

function formatPST(iso) {
  try {
    const d = new Date(
      new Date(iso).toLocaleString("en-US", { timeZone: "America/Los_Angeles" })
    );
    return d.toLocaleString("en-US", {
      month: "numeric",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit",
      hour12: true
    }).replace(",", "");
  } catch {
    return "";
  }
}

function imgOrPlaceholder(src, alt = "", right = false) {
  if (!src) {
    return `<span class="team-logo${right ? " right" : ""}">
      <svg width="28" height="22" viewBox="0 0 28 22" xmlns="http://www.w3.org/2000/svg">
        <rect width="28" height="22" rx="4" fill="#444"/>
      </svg>
    </span>`;
  }
  return `<img src="${src}" class="team-logo${right ? " right" : ""}" alt="${alt}">`;
}

/* ROUND META */
function roundMeta(t) {
  t = (t || "").toLowerCase();
  if (t.includes("wild")) return { cls: "round-wildcard", label: "Wild Card" };
  if (t.includes("divis")) return { cls: "round-divisional", label: "Divisional" };
  if (t.includes("conf")) return { cls: "round-conference", label: "Conference" };
  if (t.includes("super")) return { cls: "round-super", label: "Super Bowl" };
  return { cls: "round-wildcard", label: t || "Playoffs" };
}

function buildRoundPill(text) {
  const m = roundMeta(text);
  const emblem = `<svg width="36" height="28" viewBox="0 0 36 28" xmlns="http://www.w3.org/2000/svg">
    <rect width="36" height="28" rx="6" fill="rgba(255,255,255,0.12)"/>
    <g transform="translate(8,6)" fill="white" opacity="0.95">
      <circle cx="5" cy="5" r="4"></circle>
      <rect x="14" y="3" width="10" height="6" rx="2"></rect>
    </g>
  </svg>`;
  return `<span class="round-pill ${m.cls}"><span class="round-icon">${emblem}</span>${m.label}</span>`;
}

/* FETCH WITH FALLBACK */
async function fetchJson(url) {
  try {
    const r = await fetch(url, { cache: "no-store" });
    if (r.ok) return r.json();
  } catch {}
  try {
    const r2 = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
    if (r2.ok) return r2.json();
  } catch {}
  return null;
}

/* MAIN FETCH */
let LAST = null, TS = 0;
const CACHE_TTL = 30000;

async function fetchScores() {
  const now = Date.now();
  if (LAST && (now - TS) < CACHE_TTL) {
    startTicker(buildTickerHtml(LAST));
    return;
  }

  const segments = [];
  const playoffGroups = {};

  for (const lg of leagues) {
    try {
      const data = await fetchJson(lg.url);
      if (!data) continue;

      const events = (data.events || []).filter(e =>
        [2, 3].includes(safe(e, "season.type", 0))
      );

      for (const ev of events) {
        const comp = safe(ev, "competitions.0", null);
        if (!comp) continue;

        const away = (comp.competitors || []).find(t => t.homeAway === "away");
        const home = (comp.competitors || []).find(t => t.homeAway === "home");
        if (!away || !home) continue;

        const iso = ev.date || comp.date;
        const kickoff = iso ? formatPST(iso) : "";

        const status = safe(comp, "status.type", {});
        const state = safe(status, "state", "");
        const isLive = state === "in";

        const statusText = isLive
          ? "LIVE"
          : (safe(status, "shortDetail", "") || safe(status, "type.text", "") || "");

        /* 3-network limit */
        const broadcasts = safe(comp, "broadcasts", []) || safe(ev, "broadcasts", []) || [];
        let networkObj =
          broadcasts.find(b => b.market === "national") ||
          broadcasts[0] ||
          null;

        let networkNames = [];
        if (networkObj && Array.isArray(networkObj.names)) {
          networkNames = networkObj.names.slice(0, 3);
        } else if (networkObj && networkObj.name) {
          networkNames = [networkObj.name];
        }
        const network = networkNames.join(", ");

        const leagueColor = leagueColors[lg.name] || "#222";

        const awayLogo = safe(away, "team.logo", safe(away, "team.logos.0.href", ""));
        const homeLogo = safe(home, "team.logo", safe(home, "team.logos.0.href", ""));
        const awayAbbr = safe(away, "team.abbreviation", safe(away, "team.displayName", "")).toUpperCase();
        const homeAbbr = safe(home, "team.abbreviation", safe(home, "team.displayName", "")).toUpperCase();

        const awayScore = safe(away, "score", "");
        const homeScore = safe(home, "score", "");

        const isPlayoff = safe(ev, "season.type", 0) === 3;
        const round = isPlayoff ? safe(comp, "notes.0.headline", safe(ev, "league.name", "Playoffs")) : "";

        const item = {
          league: lg.name,
          leagueColor,
          isPlayoff,
          round,
          iso,
          kickoff,
          network,
          away: { abbr: awayAbbr, logo: awayLogo, score: awayScore },
          home: { abbr: homeAbbr, logo: homeLogo, score: homeScore },
          isLive,
          statusText
        };

        if (isPlayoff) {
          playoffGroups[round] = playoffGroups[round] || [];
          playoffGroups[round].push(item);
        } else {
          segments.push(item);
        }
      }
    } catch (err) {
      console.error("fetchScores league error:", lg.name, err);
    }
  }

  const finalList = [];

  const rounds = Object.keys(playoffGroups).sort((a, b) => a.localeCompare(b));
  for (const r of rounds) {
    const arr = playoffGroups[r].sort((x, y) => pstTimestamp(x.iso) - pstTimestamp(y.iso));
    finalList.push({ header: r });
    finalList.push(...arr);
  }

  const regularSorted = segments.sort((a, b) => pstTimestamp(a.iso) - pstTimestamp(b.iso));
  if (regularSorted.length) {
    finalList.push({ header: "Regular" });
    finalList.push(...regularSorted);
  }

  const seen = new Set();
  const deduped = [];
  for (const it of finalList) {
    if (it.header) {
      deduped.push(it);
      continue;
    }
    const key = `${it.iso}|${it.away.abbr}|${it.home.abbr}`;
    if (!seen.has(key)) {
      seen.add(key);
      deduped.push(it);
    }
  }

  LAST = deduped;
  TS = Date.now();

  startTicker(buildTickerHtml(deduped));
}

/* BUILD HTML */
function buildTickerHtml(list) {
  if (!list || list.length === 0) return "";

  const out = [];
  for (const it of list) {
    if (it.header) {
      out.push(buildRoundPill(it.header));
      continue;
    }

    const awayImg = imgOrPlaceholder(it.away.logo, it.away.abbr, false);
    const homeImg = imgOrPlaceholder(it.home.logo, it.home.abbr, true);

    const scorePart =
      (it.away.score !== "" || it.home.score !== "") ?
        `${it.away.score} – ${it.home.score}` :
        `${it.kickoff}`;

    const networkPart = it.network ? ` • ${it.network}` : "";

    out.push(`
      <span class="game-pill" style="background:${it.leagueColor};">
        ${awayImg}
        <strong>${it.away.abbr}</strong>
        <span style="opacity:0.95;">${scorePart}</span>
        <strong>${it.home.abbr}</strong>
        ${homeImg}
        <span class="${it.isLive ? "live" : ""}" style="opacity:0.9;">${it.statusText}${networkPart}</span>
      </span>
    `);
  }

  return out.join('<span class="separator"></span>');
}

/* START TICKER */
function startTicker(content) {
  const wrap = document.getElementById("tickerWrap");
  const t = document.getElementById("ticker");

  if (!content) {
    wrap.classList.add("hidden");
    t.className = "ticker";
    t.innerHTML = "No games available";
    return;
  }

  wrap.classList.remove("hidden");
  t.className = "ticker";
  t.innerHTML = content;
  void t.offsetWidth;
  t.classList.add("scroll");

  setTimeout(fetchScores, 70000 + PAUSE_BETWEEN_LOOPS);
}

fetchScores();
</script>
</body>
</html>
