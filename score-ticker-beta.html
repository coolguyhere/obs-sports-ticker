<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sports Scores Ticker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }

    .ticker-wrap {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 80px;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      overflow: hidden;
      transition: opacity 0.8s ease;
      padding-left: 12px;
      box-sizing: border-box;
    }

    .ticker-wrap.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .ticker {
      white-space: nowrap;
      padding-left: 100%;
      font-size: 28px;
      color: white;
      opacity: 0;
      will-change: transform, opacity;
    }

    .scroll {
      animation:
        fadeIn 1.5s ease forwards,
        scroll 70s linear forwards,
        fadeOut 1.5s ease forwards;
      animation-delay: 0s, 0s, 68.5s;
    }

    @keyframes scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .live {
      color: #00ff7f;
      font-weight: bold;
      animation: livePulse 1.6s infinite;
    }

    @keyframes livePulse {
      0% { text-shadow: 0 0 0 rgba(0,255,127,0.0); }
      50% { text-shadow: 0 0 8px rgba(0,255,127,0.35); }
      100% { text-shadow: 0 0 0 rgba(0,255,127,0.0); }
    }

    /* Improved separator: subtle vertical bar with shadow */
    .separator {
      display: inline-block;
      width: 2px;
      height: 28px;
      margin: 0 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.35));
      border-radius: 2px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.35);
      vertical-align: middle;
    }

    /* Team logo sizing: base height + 15% scale */
    .team-logo {
      height: 22px;
      transform: scale(1.15);
      transform-origin: center;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
    .team-logo.right {
      margin-left: 6px;
      margin-right: 0;
    }

    /* Small pill tweaks for better legibility */
    .game-pill {
      padding: 6px 12px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #fff;
      font-size: 18px;
    }

    /* Round pill styling */
    .round-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      color: #fff;
      font-size: 16px;
      margin: 0 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      vertical-align: middle;
    }

    .round-pill .round-icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      border-radius: 50%;
      flex: 0 0 20px;
      box-shadow: inset 0 -2px 6px rgba(0,0,0,0.25);
    }

    /* Round color map */
    .round-wildcard { background: linear-gradient(135deg,#2b8cff,#1a6bff); }
    .round-divisional { background: linear-gradient(135deg,#ff7a2b,#ff4b1a); }
    .round-conference { background: linear-gradient(135deg,#7b2bff,#4b1aff); }
    .round-super { background: linear-gradient(135deg,#ffd700,#ffb400); }

    /* Header style fallback */
    .round-header { display:none; }

    /* Hide images that fail to load gracefully */
    img.team-logo { object-fit: contain; }
  </style>
</head>
<body>
  <div class="ticker-wrap" id="tickerWrap">
    <div class="ticker" id="ticker">Loading today’s scores…</div>
  </div>

  <script>
    // Configuration
    const PAUSE_BETWEEN_LOOPS = 3000;
    const leagues = [
      { name: "NFL", url: "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard" },
      { name: "NBA", url: "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard" },
      { name: "MLB", url: "https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard" },
      { name: "NHL", url: "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard" }
    ];
    const leagueColors = {
      NFL: "#013369",
      NBA: "#17408B",
      MLB: "#002D72",
      NHL: "#111111"
    };

    // --- helpers ---
    function safe(obj, path, fallback = "") {
      try {
        return path.split(".").reduce((o, k) => (o && o[k] !== undefined ? o[k] : undefined), obj) ?? fallback;
      } catch {
        return fallback;
      }
    }

    function formatPST(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString("en-US", {
          timeZone: "America/Los_Angeles",
          month: "numeric",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true
        }).replace(",", "");
      } catch {
        return "";
      }
    }

    function imgOrPlaceholder(src, alt = "", isRight = false) {
      if (!src) {
        return `<span class="team-logo${isRight ? " right" : ""}" style="display:inline-block;">
          <svg width="28" height="18" viewBox="0 0 28 18" xmlns="http://www.w3.org/2000/svg" style="display:block;">
            <rect width="28" height="18" rx="3" fill="#444"/>
          </svg>
        </span>`;
      }
      return `<img src="${src}" class="team-logo${isRight ? " right" : ""}" alt="${alt}">`;
    }

    // Map round text to pill class and label
    function roundMeta(roundText) {
      const t = (roundText || "").toLowerCase();
      if (t.includes("wild")) return { cls: "round-wildcard", label: "Wild Card" };
      if (t.includes("divis")) return { cls: "round-divisional", label: "Divisional" };
      if (t.includes("conf") || t.includes("conference")) return { cls: "round-conference", label: "Conference" };
      if (t.includes("super") || t.includes("super bowl")) return { cls: "round-super", label: "Super Bowl" };
      // fallback
      return { cls: "round-wildcard", label: roundText || "Playoffs" };
    }

    // Build round pill HTML with small emblem
    function buildRoundPill(roundText) {
      const meta = roundMeta(roundText);
      // small emblem: simple SVG with two-tone circle
      const emblem = `<span class="round-icon" aria-hidden="true" style="background:linear-gradient(135deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));"></span>`;
      return `<span class="round-pill ${meta.cls}" role="note" aria-label="${meta.label}">${emblem}<span>${meta.label}</span></span>`;
    }

    // --- resilient fetch with proxy fallback ---
    async function fetchJsonWithFallback(url) {
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (r.ok) {
          const j = await r.json();
          return { ok: true, json: j, source: "direct" };
        }
      } catch (e) {}
      try {
        const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
        const r2 = await fetch(proxy);
        if (r2.ok) {
          const j2 = await r2.json();
          return { ok: true, json: j2, source: "proxy" };
        }
      } catch (e) {}
      return { ok: false };
    }

    // --- main robust fetch + render ---
    let LAST_FETCH_TS = 0;
    let LAST_DATA = null;
    const CACHE_TTL = 30 * 1000;

    async function fetchScores() {
      const now = Date.now();
      if (LAST_DATA && (now - LAST_FETCH_TS) < CACHE_TTL) {
        startTicker(buildTickerHtml(LAST_DATA));
        return;
      }

      const segments = [];
      const playoffGroups = {};

      for (const league of leagues) {
        try {
          const res = await fetchJsonWithFallback(league.url);
          if (!res.ok || !res.json) continue;
          console.debug('fetch source', league.name, res.source);

          const data = res.json;
          const events = (data.events || []).filter(e => [2,3].includes(safe(e, "season.type", 0)));

          for (const event of events) {
            const comp = safe(event, "competitions.0", null);
            if (!comp) continue;

            const away = (comp.competitors || []).find(t => t.homeAway === "away");
            const home = (comp.competitors || []).find(t => t.homeAway === "home");
            if (!away || !home) continue;

            const status = safe(comp, "status.type", {});
            const isLive = safe(status, "state", "") === "in";
            const statusText = isLive ? "LIVE" : (safe(status, "shortDetail", "") || safe(status, "type.text", "") || "");

            const iso = event.date || comp.date;
            const kickoff = iso ? formatPST(iso) : "";

            const network = (safe(comp, "broadcasts", []) || safe(event, "broadcasts", []) || [])
              .find(b => b.market === "national") || (safe(comp, "broadcasts.0", {}) || safe(event, "broadcasts.0", {}));
            const networkName = network ? (network.names ? network.names.join(", ") : (network.name || "")) : "";

            const leagueColor = leagueColors[league.name] || "#222";

            const awayLogo = safe(away, "team.logo", safe(away, "team.logos.0.href", ""));
            const homeLogo = safe(home, "team.logo", safe(home, "team.logos.0.href", ""));
            const awayAbbr = safe(away, "team.abbreviation", safe(away, "team.displayName", away.team?.name || "")).toUpperCase();
            const homeAbbr = safe(home, "team.abbreviation", safe(home, "team.displayName", home.team?.name || "")).toUpperCase();

            const awayScore = safe(away, "score", "");
            const homeScore = safe(home, "score", "");

            const isPlayoff = safe(event, "season.type", 0) === 3;
            const round = isPlayoff ? (safe(comp, "notes.0.headline", safe(event, "league.name", "Playoffs"))) : "";

            const item = {
              league: league.name,
              leagueColor,
              isPlayoff,
              round,
              iso,
              kickoff,
              network: networkName,
              away: { abbr: awayAbbr, logo: awayLogo, score: awayScore },
              home: { abbr: homeAbbr, logo: homeLogo, score: homeScore },
              isLive,
              statusText
            };

            if (isPlayoff) {
              playoffGroups[round] = playoffGroups[round] || [];
              playoffGroups[round].push(item);
            } else {
              segments.push(item);
            }
          }
        } catch (err) {
          console.error("fetchScores league error:", league.name, err);
        }
      }

      const finalList = [];
      const rounds = Object.keys(playoffGroups).sort((a,b) => a.localeCompare(b));
      for (const r of rounds) {
        const arr = playoffGroups[r].sort((x,y) => {
          const tx = x.iso ? new Date(x.iso).getTime() : Infinity;
          const ty = y.iso ? new Date(y.iso).getTime() : Infinity;
          return tx - ty;
        });
        finalList.push({ header: r });
        finalList.push(...arr);
      }

      const regularSorted = segments.sort((a,b) => {
        const ta = a.iso ? new Date(a.iso).getTime() : Infinity;
        const tb = b.iso ? new Date(b.iso).getTime() : Infinity;
        return ta - tb;
      });
      if (regularSorted.length) {
        finalList.push({ header: "Regular" });
        finalList.push(...regularSorted);
      }

      const seen = new Set();
      const deduped = [];
      for (const it of finalList) {
        if (it.header) { deduped.push(it); continue; }
        const key = `${it.iso}|${it.away.abbr}|${it.home.abbr}`;
        if (!seen.has(key)) { seen.add(key); deduped.push(it); }
      }

      LAST_FETCH_TS = Date.now();
      LAST_DATA = deduped;

      startTicker(buildTickerHtml(deduped));
    }

    function buildTickerHtml(list) {
      if (!list || list.length === 0) return "";

      const parts = [];
      for (const item of list) {
        if (item.header) {
          // render round pill with color and emblem
          parts.push(buildRoundPill(item.header));
          continue;
        }

        const liveClass = item.isLive ? "live" : "";
        const awayImg = imgOrPlaceholder(item.away.logo, item.away.abbr, false);
        const homeImg = imgOrPlaceholder(item.home.logo, item.home.abbr, true);

        const scorePart = (item.away.score !== "" || item.home.score !== "") ?
          `${item.away.score} – ${item.home.score}` : `${item.kickoff}`;

        const networkPart = item.network ? ` • ${item.network}` : "";

        parts.push(`
          <span class="game-pill" style="background:${item.leagueColor};">
            ${awayImg}
            <strong>${item.away.abbr}</strong>
            <span style="opacity:0.95; margin:0 6px;">${scorePart}</span>
            <strong>${item.home.abbr}</strong>
            ${homeImg}
            <span style="margin-left:8px; opacity:0.9;" class="${liveClass}">${item.statusText}${networkPart}</span>
          </span>
        `);
      }

      // join with improved separator element
      return parts.join('<span class="separator" aria-hidden="true"></span>');
    }

    function startTicker(content) {
      const ticker = document.getElementById("ticker");
      const wrap = document.getElementById("tickerWrap");

      if (!content) {
        wrap.classList.add('hidden');
        ticker.className = "ticker";
        ticker.innerHTML = "No games available";
        return;
      } else {
        wrap.classList.remove('hidden');
      }

      ticker.className = "ticker";
      ticker.innerHTML = content || "No games available";
      void ticker.offsetWidth;
      if (content) ticker.classList.add("scroll");
      setTimeout(fetchScores, 70000 + PAUSE_BETWEEN_LOOPS);
    }

    // initial call
    fetchScores();
  </script>
</body>
</html>
