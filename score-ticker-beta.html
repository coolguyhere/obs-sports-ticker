<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sports Ticker — Bottom Rail with LIVE Quarter (Fixed Layout)</title>

<style>
:root{
  --bar-h: 52px;
  --bg: #0f0f10;
  --text: #ffffff;
  --pill-bg: #242424;
  --pill-pad: 8px 16px;
  --sep: 20px;
  --round-bg: #222;
  --round-text: #fff;
  --font: 24px; /* pill text size */
  --pill-radius: 4px;
  --live-color: #00ff7f;
  --high-color: #ff4b4b;
  --pst-bg: #1f4b8f;
  --pst-text: #fff;
}

/* Page */
html,body{height:100%;margin:0;background:#000;font-family:Arial,Helvetica,sans-serif;color:var(--text);}

/* Bottom pinned wrapper */
.ticker-wrapper{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  z-index:9999;
  pointer-events:none;
}

/* Bar */
.ticker-bar{
  height:var(--bar-h);
  background:var(--bg);
  display:flex;
  align-items:center;
  border-top:3px solid #c00;
  transition:background 300ms ease, border-top 300ms ease, box-shadow 300ms ease;
  overflow:hidden;
  pointer-events:auto;
}

/* Viewport */
.rail-viewport{
  position:relative;
  width:100%;
  height:var(--bar-h);
  overflow:hidden;
  white-space:nowrap;
}

/* Two rails positioned absolutely for duplication */
#rail, #rail-dup, #rail-staging {
  position:absolute;
  top:0;
  left:0;
  display:inline-flex;
  align-items:center;
  height:var(--bar-h);
  will-change:transform;
}

/* Pills (now flex with left main + right status) */
/* Pills — make left content and right status layout */
.pill{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--pill-bg);
  color:var(--text);
  padding:var(--pill-pad);
  margin-right:var(--sep);
  border-radius:var(--pill-radius);
  font-size:var(--font);
  height:calc(var(--bar-h) - 12px);
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 6px rgba(0,0,0,0.45);
  gap:8px;
  box-sizing:border-box;
}

/* left group contains logos + abbreviations */
.pill-left{ display:flex; align-items:center; gap:8px; white-space:nowrap; overflow:hidden; }

/* right-aligned status */
.pill-status{ min-width:72px; text-align:right; font-weight:700; white-space:nowrap; margin-left:12px; }


/* PST pill */
.pst-pill{
  background:var(--pst-bg);
  color:var(--pst-text);
  font-weight:700;
  text-transform:uppercase;
  padding:6px 12px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 2px 8px rgba(0,0,0,0.35);
  font-size:14px;
}

/* Header pill (round) */
.header-pill{
  background:var(--round-bg);
  color:var(--round-text);
  font-weight:700;
  text-transform:uppercase;
  padding-left:14px;
  padding-right:14px;
}

/* Super Bowl special pill */
.superbowl-pill{
  background: linear-gradient(90deg,#d4af37,#f7e27c);
  color:#0a0a0a;
  font-weight:900;
  border:1px solid rgba(0,0,0,0.35);
  box-shadow:0 4px 18px rgba(212,175,55,0.6);
}

/* Logos */
.pill img.logo{ height:calc(var(--bar-h) * 0.55); width:auto; margin-right:6px; display:inline-block; }
.team-logo{
  height:calc(var(--bar-h) * 0.55);
  width:auto;
  margin:0 6px;
  border:1px solid rgba(255,255,255,0.25);
  border-radius:6px;
  background:rgba(255,255,255,0.05);
  display:inline-block;
}

/* Score text */
.score-text{
  font-size:var(--font);
  white-space:nowrap;
  font-weight:700;
}

/* Compact score pair for live (keeps scores inline) */
.score-pair{
  display:flex;
  gap:6px;
  align-items:center;
  font-weight:700;
  font-size:var(--font);
}

/* status on the far right of pill */
.pill-status{
  margin-left:18px;
  font-weight:700;
  opacity:0.95;
  min-width:80px;
  text-align:right;
}

/* status variants */
.status-live { color: var(--live-color); }
.status-final { color: #cccccc; }
.status-ot { color: var(--high-color); }
.status-future { color: #dcdcdc; }

/* high-leverage visual emphasis */
.high-leverage {
  box-shadow: 0 0 12px rgba(255,0,0,0.45);
  animation: pulse 1.8s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 0 6px rgba(255,0,0,0.25); }
  50% { box-shadow: 0 0 14px rgba(255,0,0,0.7); }
  100% { box-shadow: 0 0 6px rgba(255,0,0,0.25); }
}

/* Small responsive tweak */
@media (max-width:520px){
  :root{ --font:18px; --bar-h:44px; --pill-pad:6px 10px; --sep:14px; }
  .team-logo, .pill img.logo{ height:calc(var(--bar-h) * 0.55); }
  .pst-pill{ font-size:12px; padding:6px 10px; }
  .pill { min-width: 140px; padding:6px 8px; font-size:16px; gap:8px; }
  .pill-status { min-width:50px; font-size:12px; }
}
</style>
</head>
<body>

<div class="ticker-wrapper">
  <div class="ticker-bar" id="tickerBar">
    <div class="rail-viewport" id="viewport">
      <div id="rail" aria-hidden="false"></div>
      <div id="rail-dup" aria-hidden="true"></div>
      <div id="rail-staging" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
/* -------------------------
   CONFIG (edit these)
   ------------------------- */
const DISPLAY_TIMEZONE = "America/Los_Angeles"; // lock to PST; changeable
const SLOW_FACTOR = 0.6; // multiply speed when high-leverage (0.6 => 40% slower)
const TARGET_LOOP_SECONDS = 36; // base loop time before clamping
const MIN_SPEED = 40;
const MAX_SPEED = 160;
const CACHE_TTL = 15000;

/* -------------------------
   LEAGUES
   ------------------------- */
const LEAGUES = [
  { name:"NFL", key:"nfl", url:"https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard" },
  { name:"NBA", key:"nba", url:"https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard" },
  { name:"MLB", key:"mlb", url:"https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard" },
  { name:"NHL", key:"nhl", url:"https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard" }
];

const LEAGUE_LOGOS = {
  nfl: "https://a.espncdn.com/i/teamlogos/leagues/500/nfl.png",
  nba: "https://a.espncdn.com/i/teamlogos/leagues/500/nba.png",
  mlb: "https://a.espncdn.com/i/teamlogos/leagues/500/mlb.png",
  nhl: "https://a.espncdn.com/i/teamlogos/leagues/500/nhl.png"
};

/* -------------------------
   STATE
   ------------------------- */
let CACHE = null;
let CACHE_TS = 0;

let rail = null;
let railDup = null;
let railStaging = null;
let tickerBar = null;
let viewport = null;

let x = 0;
let lastTs = null;
let smoothedFps = 60;
let lastFpsTs = performance.now();

let currentItems = [];
let highLeveragePresent = false;

/* -------------------------
   HELPERS
   ------------------------- */
function safe(obj, path, fallback=""){
  try{ return path.split('.').reduce((o,k)=>o[k], obj) ?? fallback; } catch { return fallback; }
}
function pstTimestamp(iso){ return new Date(iso).getTime(); }
function formatGameTime(iso){
  return new Date(iso).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',timeZone:DISPLAY_TIMEZONE});
}
function formatDateTimeMMDD(iso){
  const d = new Date(iso);
  const mm = String(d.getMonth() + 1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  let h = d.getHours();
  const m = String(d.getMinutes()).padStart(2,'0');
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return `${mm}/${dd} ${h}:${m} ${ampm}`;
}
function normalizeRound(raw){
  const t = (raw||'').toUpperCase();
  if(t.includes('WILD')) return 'WILD CARD';
  if(t.includes('DIVISION')) return 'DIVISIONAL';
  if(t.includes('CHAMP') && !t.includes('SUPER')) return 'CONF CHAMPIONSHIP';
  if(t.includes('SUPER')) return 'SUPER BOWL';
  return 'Regular';
}
function gameState(item){
  if(item.isLive) return 1;
  if((item.statusText||'').toUpperCase().includes('FINAL')) return 2;
  return 0;
}

/* high-leverage detection (late quarter/period or OT) */
function isHighLeverage(item){
  if(!item.isLive) return false;
  const p = Number(item.period) || 0;
  const s = (item.statusText||'').toUpperCase();
  if(s.includes('OT') || s.includes('OVERTIME')) return true;
  if(item.leagueKey === 'nfl' && p >= 4) return true;
  if(item.leagueKey === 'nba' && p >= 4) return true;
  if(item.leagueKey === 'nhl' && (p >= 3 || s.includes('OT'))) return true;
  if(item.leagueKey === 'mlb' && p >= 9) return true;
  return false;
}

/* -------------------------
   FETCH (proxy)
   ------------------------- */
async function fetchJson(url){
  // stable public proxy for CORS (read-only)
  const proxyBase = "https://api.allorigins.win/raw?url=";
  try{
    const r = await fetch(proxyBase + encodeURIComponent(url), { cache: "no-store" });
    if(r.ok) return r.json();
  }catch(e){
    console.error('fetchJson error', e);
  }
  return null;
}

/* -------------------------
   UNIFIED SCORE FETCH (captures period/clock and scores)
   ------------------------- */
async function fetchScores(){
  const now = Date.now();
  if(CACHE && (now - CACHE_TS) < CACHE_TTL) return CACHE;

  const allGames = []; // we will collect games across leagues
  let foundPlayoffs = false;
  let foundSuperBowl = false;

  for(const lg of LEAGUES){
    try{
      const data = await fetchJson(lg.url);
      if(!data) continue;
      const events = (data.events || []).slice();

      // collect per-league games
      for(const ev of events){
        const seasonType = safe(ev, 'season.type', 0);
        // keep regular + playoffs (seasonType 2 = regular, 3 = playoffs); adapt if needed
        if(seasonType !== 2 && seasonType !== 3) continue;

        const comp = safe(ev, 'competitions.0', null);
        if(!comp) continue;

        const away = (comp.competitors || []).find(t=>t.homeAway==='away');
        const home = (comp.competitors || []).find(t=>t.homeAway==='home');
        if(!away || !home) continue;

        const iso = ev.date || comp.date || '';
        if(!iso) continue;

        const ts = pstTimestamp(iso);
        const daysOut = (ts - Date.now()) / 86400000;
        if(daysOut > 365) continue; // avoid absurd far-future entries

        const status = safe(comp, 'status.type', {});
        const state = safe(status, 'state', '');
        const isLive = state === 'in';
        const statusTextRaw = safe(status,'shortDetail','') || safe(status,'type.text','') || '';
        const statusText = (isLive ? 'LIVE' : statusTextRaw);

        const displayClock = safe(status, 'displayClock', '') || safe(comp, 'status.displayClock', '') || '';
        const period = safe(status, 'period', '') || safe(comp, 'status.period', '') || '';

        const awayLogo = safe(away, 'team.logo', safe(away,'team.logos.0.href',''));
        const homeLogo = safe(home, 'team.logo', safe(home,'team.logos.0.href',''));
        const awayAbbr = (safe(away,'team.abbreviation', safe(away,'team.displayName','')) || '').toUpperCase();
        const homeAbbr = (safe(home,'team.abbreviation', safe(home,'team.displayName','')) || '').toUpperCase();
        const awayScore = safe(away,'score','') || '';
        const homeScore = safe(home,'score','') || '';

        const isPlayoff = seasonType === 3;
        if(isPlayoff) foundPlayoffs = true;

        const roundRaw = safe(comp, 'notes.0.headline', safe(ev,'league.name','Playoffs'));
        const round = normalizeRound(roundRaw);
        if(round === 'SUPER BOWL') foundSuperBowl = true;

        const item = {
          type: 'game',
          league: lg.name,
          leagueKey: lg.key.toLowerCase(),
          isPlayoff,
          round,
          iso,
          kickoff: formatGameTime(iso),
          away: { abbr: awayAbbr, logo: awayLogo, score: awayScore },
          home: { abbr: homeAbbr, logo: homeLogo, score: homeScore },
          isLive,
          statusText,
          displayClock,
          period
        };

        allGames.push(item);
      }

    }catch(err){
      console.error('League fetch error', lg.name, err);
    }
  }

  // dedupe by iso|away|home|league
  const seen = new Set();
  const dedup = [];
  for(const g of allGames){
    const key = `${g.iso}|${g.away.abbr}|${g.home.abbr}|${g.league}`;
    if(!seen.has(key)){ seen.add(key); dedup.push(g); }
  }

  // sort within categories
  const liveGames = dedup.filter(d=>gameState(d) === 1).sort((a,b)=>pstTimestamp(a.iso)-pstTimestamp(b.iso));
  const finalGames = dedup.filter(d=>gameState(d) === 2).sort((a,b)=>pstTimestamp(a.iso)-pstTimestamp(b.iso));
  const futureGames = dedup.filter(d=>gameState(d) === 0).sort((a,b)=>pstTimestamp(a.iso)-pstTimestamp(b.iso));

  // final assembled items order: superbowl pill (if found & playoff scheduled), LIVE first, FINAL next, FUTURE last
  const assembled = [];

  if(foundSuperBowl){
    assembled.push({ type:'superbowl' });
  }

  // push live games first
  liveGames.forEach(g => assembled.push(g));
  // push final
  finalGames.forEach(g => assembled.push(g));
  // push future
  futureGames.forEach(g => assembled.push(g));

  // update cache and high-leverage flag
  CACHE = assembled;
  CACHE_TS = Date.now();
  highLeveragePresent = assembled.some(it => it.type==='game' && isHighLeverage(it));
  currentItems = assembled.slice();
  return assembled;
}

/* -------------------------
   RENDERING HELPERS
   ------------------------- */
function createPSTPill(){
  const pill = document.createElement('span');
  pill.className = 'pill pst-pill';
  pill.textContent = 'All times PST';
  return pill;
}

function createSuperBowlPill(){
  const pill = document.createElement('span');
  pill.className = 'pill superbowl-pill';
  pill.textContent = 'SUPER BOWL — EVENT SCHEDULED';
  return pill;
}

function periodLabelForLeague(leagueKey, period, displayClock = '', statusText = '') {
  const st = (statusText || '').toUpperCase();

  // explicit OT / OVERTIME override
  if (st.includes('OT') || st.includes('OVERTIME')) return 'OT';

  // if no numeric period, fall back to readable status (Top/Bot etc)
  if (period === null || period === undefined || period === '') {
    if (st) return st;
    return '';
  }

  const p = Number(period);
  if (!Number.isFinite(p)) {
    if (st) return st;
    return '';
  }

  // league-specific labels
  if (leagueKey === 'mlb') {
    // MLB: prefer Top/Bottom wording from status if present ("Top 7th", "Bot 9th")
    if (/TOP|BOT/i.test(st)) return st;
    return `IN ${p}`;
  }
  if (leagueKey === 'nhl') {
    return `P${p}`; // period
  }
  if (leagueKey === 'nfl' || leagueKey === 'nba') {
    return `Q${p}`; // quarter
  }

  return `P${p}`;
}


function createGamePill(item){
  const pill = document.createElement('span');
  pill.className = 'pill';

  // left block (league logo + team/score flow)
  const left = document.createElement('div');
  left.className = 'pill-left';

  // optional league logo (small)
  const leagueLogo = document.createElement('img');
  leagueLogo.className = 'logo';
  leagueLogo.src = LEAGUE_LOGOS[item.leagueKey] || '';
  leagueLogo.alt = item.leagueKey ? item.leagueKey.toUpperCase() : '';
  leagueLogo.onerror = () => leagueLogo.hidden = true;
  left.appendChild(leagueLogo);

  // away logo + abbr
  const awayLogo = document.createElement('img');
  awayLogo.className = 'team-logo';
  awayLogo.src = item.away.logo || '';
  awayLogo.onerror = ()=>awayLogo.hidden = true;
  left.appendChild(awayLogo);

  const awayAbbr = document.createElement('span');
  awayAbbr.textContent = item.away.abbr;
  left.appendChild(awayAbbr);

  // score / kickoff block (keeps inline)
  if(item.isLive){
    const pair = document.createElement('div');
    pair.className = 'score-pair';
    const awayScore = document.createElement('span');
    awayScore.textContent = item.away.score || '0';
    const dash = document.createElement('span');
    dash.textContent = '–';
    const homeScore = document.createElement('span');
    homeScore.textContent = item.home.score || '0';
    pair.appendChild(awayScore);
    pair.appendChild(dash);
    pair.appendChild(homeScore);
    left.appendChild(pair);
  } else if((item.statusText||'').toUpperCase().includes('FINAL')) {
    const finalText = document.createElement('span');
    finalText.className = 'score-text';
    finalText.textContent = `${item.away.score} - ${item.home.score} FINAL`;
    left.appendChild(finalText);
  } else {
    const upcoming = document.createElement('span');
    upcoming.className = 'score-text';
    upcoming.textContent = item.kickoff || formatDateTimeMMDD(item.iso);
    left.appendChild(upcoming);
  }

  // home abbr + logo
  const homeAbbr = document.createElement('span');
  homeAbbr.textContent = item.home.abbr;
  left.appendChild(homeAbbr);

  const homeLogo = document.createElement('img');
  homeLogo.className = 'team-logo';
  homeLogo.src = item.home.logo || '';
  homeLogo.onerror = ()=>homeLogo.hidden = true;
  left.appendChild(homeLogo);

  // right status block (far right of pill)
  const status = document.createElement('div');
  status.className = 'pill-status';

  const state = gameState(item);
  if(state === 1){ // live
    const periodLabel = periodLabelForLeague(item.leagueKey, item.period, item.displayClock, item.statusText);
    status.textContent = periodLabel ? `LIVE ${periodLabel}` : 'LIVE';
    status.classList.add('status-live');
  } else if(state === 2) {
    status.textContent = 'FINAL';
    status.classList.add('status-final');
  } else {
    status.textContent = item.kickoff || '';
    status.classList.add('status-future');
  }

  // visual emphasis for high-leverage
  if (isHighLeverage(item)) {
    pill.classList.add('high-leverage');
  }

  pill.appendChild(left);
  pill.appendChild(status);

  return pill;
}


/* -------------------------
   BUILD DOUBLE RAILS
   ------------------------- */
function buildDoubleRail(items){
  rail.innerHTML = '';
  railDup.innerHTML = '';

  // create PST pill once and prepend to both rails
  const pst = createPSTPill();
  rail.appendChild(pst.cloneNode(true));
  railDup.appendChild(pst.cloneNode(true));

  for(const it of items){
    let node = null;
    if(it.type === 'superbowl'){
      node = createSuperBowlPill();
    } else if(it.type === 'game'){
      node = createGamePill(it);
    } else {
      continue;
    }
    // append clone for both rails
    rail.appendChild(node.cloneNode(true));
    railDup.appendChild(node.cloneNode(true));
  }

  // set transforms initially
  rail.style.transform = `translateX(${x}px)`;
  const primaryWidth = rail.scrollWidth || 1;
  railDup.style.transform = `translateX(${x + primaryWidth}px)`;
}

/* -------------------------
   build staging (used for atomic swap)
   ------------------------- */
function buildStagingSequence(items){
  railStaging.innerHTML = '';

  const pst = createPSTPill();
  railStaging.appendChild(pst);

  for(const it of items){
    let node = null;
    if(it.type === 'superbowl'){
      node = createSuperBowlPill();
    } else if(it.type === 'game'){
      node = createGamePill(it);
    } else continue;

    railStaging.appendChild(node);
  }
}

/* -------------------------
   THEME APPLY (superbowl styling on bar)
   ------------------------- */
function applySuperBowlTheme(hasSB){
  tickerBar.classList.toggle('superbowl-bar', !!hasSB);
}

/* -------------------------
   DYNAMIC SPEED (consider high-leverage slowdown)
   ------------------------- */
function computeDynamicSpeed(){
  const primaryWidth = rail.scrollWidth || 1;
  if (primaryWidth < viewport.clientWidth + 50) {
  return MIN_SPEED;
}

const base = primaryWidth / TARGET_LOOP_SECONDS;

  // apply slowdown if high-leverage present
  return base;

}

/* -------------------------
   LOOP (double-rail)
   ------------------------- */
function loopFrame(ts){
  if(!lastTs) lastTs = ts;
  const dt = (ts - lastTs) / 1000;
  lastTs = ts;

  const frameTime = ts - lastFpsTs;
  lastFpsTs = ts;
  const currentFps = 1000 / Math.max(frameTime,1);
  smoothedFps = smoothedFps * 0.9 + currentFps * 0.1;

  let dynamicSpeed = computeDynamicSpeed();
  dynamicSpeed = Math.max(MIN_SPEED, Math.min(MAX_SPEED, dynamicSpeed));

  x -= dynamicSpeed * dt;

  const primaryWidth = rail.scrollWidth || 1;

  if(Math.abs(x) >= primaryWidth){
    x += primaryWidth;
  }

  rail.style.transform = `translateX(${x}px)`;
  railDup.style.transform = `translateX(${x + primaryWidth}px)`;

  requestAnimationFrame(loopFrame);
}

/* -------------------------
   REFRESH (staging + atomic swap)
   ------------------------- */
async function refreshData(){
  const items = await fetchScores();
  if(!items || !items.length) return;

  const hasSuperBowl = items.some(i => i.type === 'superbowl');

  buildStagingSequence(items);

  requestAnimationFrame(()=>{
    const oldPrimaryWidth = rail.scrollWidth || 1;
    const oldX = x;

    rail.innerHTML = railStaging.innerHTML;
    railDup.innerHTML = railStaging.innerHTML;

    const newPrimaryWidth = rail.scrollWidth || 1;
    const ratio = newPrimaryWidth / Math.max(oldPrimaryWidth,1);
    x = oldX * ratio;

    rail.style.transform = `translateX(${x}px)`;
    railDup.style.transform = `translateX(${x + newPrimaryWidth}px)`;

    applySuperBowlTheme(hasSuperBowl);
  });
}

/* -------------------------
   BOOTSTRAP
   ------------------------- */
async function bootstrapTicker(){
  rail = document.getElementById('rail');
  railDup = document.getElementById('rail-dup');
  railStaging = document.getElementById('rail-staging');
  tickerBar = document.getElementById('tickerBar');
  viewport = document.getElementById('viewport');

  const items = await fetchScores();
  if(!items || !items.length) return;

  buildDoubleRail(items);
  applySuperBowlTheme(items.some(i => i.type === 'superbowl'));

  // ✅ FIX #4 — PLACE IT HERE
  const primaryWidth = rail.scrollWidth || 1;
  railDup.style.transform = `translateX(${primaryWidth}px)`;

  // force initial positioning
const primaryWidth = rail.scrollWidth || 1;
x = 0;
rail.style.transform = `translateX(0px)`;
railDup.style.transform = `translateX(${primaryWidth}px)`;

// start animation immediately
lastTs = null;
requestAnimationFrame(loopFrame);


  // refresh every 15s; fetchScores has cache to avoid rapid re-fetch
  setInterval(refreshData, 15000);
}

/* -------------------------
   START
   ------------------------- */
bootstrapTicker();

</script>

</body>
</html>
