<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Top Games This Week</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
  font-family: Arial, Helvetica, sans-serif;
}

/* Top bar wrapper */
.ticker-wrap {
  position: fixed;
  top: 0;
  width: 100%;
  height: 80px;
  background: rgba(0,0,0,0.35);
  display: flex;
  align-items: center;
  overflow: hidden;
  transition: opacity 0.8s ease;
}

.ticker-wrap.hidden {
  opacity: 0;
  pointer-events: none;
}

/* Left label */
.ticker-label {
  flex: 0 0 auto;
  padding: 0 18px;
  font-size: 22px;
  font-weight: bold;
  color: #ffffff;
  text-transform: uppercase;
  border-right: 2px solid rgba(255,255,255,0.3);
}

/* Scrolling area */
.ticker {
  flex: 1 1 auto;
  white-space: nowrap;
  padding-left: 100%;
  font-size: 22px;
  color: #ffffff;
  opacity: 0;
}

.scroll {
  animation:
    fadeIn 1.5s ease forwards,
    scroll 70s linear forwards,
    fadeOut 1.5s ease forwards;
  animation-delay: 0s, 0s, 68.5s;
}

@keyframes scroll {
  from { transform: translateX(0); }
  to   { transform: translateX(-100%); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to   { opacity: 0; }
}

.separator {
  margin: 0 18px;
  color: #ffffff;
}

/* Game pill styling */
.game-pill {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 6px 12px;
}

.game-pill img {
  height: 22px;
  width: 22px;
  object-fit: contain;
}

.game-meta {
  font-size: 14px;
  opacity: 0.9;
  margin-left: 8px;
}
</style>
</head>
<body>

<div class="ticker-wrap" id="tickerWrap">
  <div class="ticker-label">Top Games This Week</div>
  <div class="ticker" id="ticker">Loading upcoming games…</div>
</div>

<script>
// ============================================================
// DEBUG CONSOLE (BOTTOM 50% PANEL)
// ============================================================

const debugPanel = document.createElement("div");
debugPanel.id = "debugPanel";
debugPanel.style.position = "fixed";
debugPanel.style.bottom = "0";
debugPanel.style.left = "0";
debugPanel.style.width = "100%";
debugPanel.style.height = "50vh";
debugPanel.style.background = "rgba(0,0,0,0.85)";
debugPanel.style.color = "#00ffea";
debugPanel.style.fontFamily = "Consolas, monospace";
debugPanel.style.fontSize = "13px";
debugPanel.style.overflowY = "auto";
debugPanel.style.zIndex = "999999";
debugPanel.style.padding = "10px";
debugPanel.style.boxSizing = "border-box";
debugPanel.style.whiteSpace = "pre-wrap";
debugPanel.style.borderTop = "2px solid #00ffea";
document.body.appendChild(debugPanel);

function dbg(msg, color = "#00ffea") {
  const line = document.createElement("div");
  line.style.color = color;
  line.textContent = msg;
  debugPanel.appendChild(line);
  debugPanel.scrollTop = debugPanel.scrollHeight;
  console.log(`%c${msg}`, `color:${color}; font-weight:bold`);
}

function dbgGroup(title) {
  dbg(`\n▼ ${title}`, "#4da6ff");
  console.group(title);
}
function dbgGroupEnd() {
  console.groupEnd();
  dbg(`▲ END GROUP`, "#4da6ff");
}

// ============================================================
// CONFIG
// ============================================================

dbgGroup("CONFIG LOADED");

const PROXY = "https://api.allorigins.win/raw?url=";

const leagues = [
  { code: "NFL", sport: "football", league: "nfl" },
  { code: "NBA", sport: "basketball", league: "nba" },
  { code: "NHL", sport: "hockey", league: "nhl" },
  { code: "MLB", sport: "baseball", league: "mlb" }
];

const leagueColors = {
  NFL: "#013369",
  NBA: "#17408B",
  MLB: "#002D72",
  NHL: "#111111"
};

const TOP_N = 5;
const LOOP_PAUSE = 1500;
const REFRESH_INTERVAL = 10 * 60 * 1000;
const SCROLL_DURATION = 70000;

dbg("Config loaded successfully", "#00ff00");
dbgGroupEnd();

// ============================================================
// UTILITIES
// ============================================================

dbgGroup("UTILITY FUNCTIONS LOADED");

function formatPST(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleString("en-US", {
      timeZone: "America/Los_Angeles",
      weekday: "short",
      hour: "numeric",
      minute: "2-digit"
    });
  } catch (e) {
    dbg(`formatPST error: ${e}`, "#ff4444");
    return "";
  }
}

function winPct(team) {
  try {
    const rec = team.record?.items?.find(r => r.type === "total");
    if (!rec || !rec.summary) return 0.5;
    const [w, l] = rec.summary.split("-").map(Number);
    return w + l === 0 ? 0.5 : w / (w + l);
  } catch {
    return 0.5;
  }
}

function anticipation(a, b) {
  return (a + b) / 2 - Math.abs(a - b);
}

dbg("Utility functions loaded", "#00ff00");
dbgGroupEnd();

// ============================================================
// HYBRID DATA PIPELINE — CBS Playoffs + ESPN Regular Season
// ============================================================

// 1. CBS PLAYOFF SCRAPER
async function fetchPlayoffGamesFromCBS() {
  dbgGroup("CBS PLAYOFF FETCH");

  const url = "https://www.cbssports.com/nfl/schedule/playoffs/";
  dbg(`CBS URL: ${url}`, "#4da6ff");

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const html = await res.text();
    dbg("CBS HTML fetched OK", "#00ff00");

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const rows = doc.querySelectorAll("table tr");
    dbg(`CBS rows found: ${rows.length}`, "#ccccff");

    const games = [];

    rows.forEach((row, idx) => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 3) return;

      const dateText = cells[0].textContent.trim();
      const timeText = cells[1].textContent.trim();
      const matchupText = cells[2].textContent.trim();

      if (!matchupText.includes("at") && !matchupText.includes("@")) return;

      dbg(`CBS row ${idx}: ${dateText} | ${timeText} | ${matchupText}`, "#ccccff");

      let [awayName, homeName] = matchupText.split(/at|@/i).map(s => s.trim());
      if (!awayName || !homeName) return;

      const rawString = `${dateText} ${timeText} PST`;
      const rawDate = new Date(rawString);
      const iso = rawDate.toISOString();

      games.push({
        league: "NFL",
        playoff: true,
        playoffRound: "Playoffs",
        rawDate: iso,
        pst: formatPST(iso),
        score: 1.0,
        away: { team: { abbreviation: awayName, logo: null }, record: null },
        home: { team: { abbreviation: homeName, logo: null }, record: null }
      });
    });

    dbg(`CBS parsed playoff games: ${games.length}`, "#ff66ff");
    dbgGroupEnd();
    return games;

  } catch (e) {
    dbg(`CBS ERROR: ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

// 2. ESPN REGULAR SEASON FETCH
async function fetchRegularGamesFromESPN() {
  dbgGroup("ESPN REGULAR FETCH");

  const allGames = [];

  for (const lg of leagues) {
    dbgGroup(`ESPN League: ${lg.code}`);

    const season = new Date().getFullYear();

    const now = new Date();
    const end = new Date(now.getTime() + 30 * 86400000);

    const startStr = now.toISOString().slice(0, 10).replace(/-/g, "");
    const endStr = end.toISOString().slice(0, 10).replace(/-/g, "");

    const scheduleURL =
      `https://sports.core.api.espn.com/v2/sports/${lg.sport}/` +
      `leagues/${lg.league}/seasons/${season}/events?dates=${startStr}-${endStr}`;

    dbg(`ESPN URL: ${scheduleURL}`, "#4da6ff");

    let scheduleData;
    try {
      const res = await fetch(PROXY + encodeURIComponent(scheduleURL));
      scheduleData = await res.json();
      dbg("ESPN schedule OK", "#00ff00");
    } catch (e) {
      dbg(`ESPN ERROR: ${e}`, "#ff4444");
      dbgGroupEnd();
      continue;
    }

    if (!scheduleData.items?.length) {
      dbg("ESPN returned NO items", "#ffaa00");
      dbgGroupEnd();
      continue;
    }

    dbg(`ESPN items: ${scheduleData.items.length}`, "#ccccff");

    for (const item of scheduleData.items) {
      dbgGroup(`ESPN Event: ${item.$ref}`);

      let ev;
      try {
        const evRes = await fetch(PROXY + encodeURIComponent(item.$ref));
        ev = await evRes.json();
        dbg("Event OK", "#00ff00");
      } catch (e) {
        dbg(`Event ERROR: ${e}`, "#ff4444");
        dbgGroupEnd();
        continue;
      }

      const comp = ev.competitions?.[0];
      if (!comp) {
        dbg("No competition", "#ffaa00");
        dbgGroupEnd();
        continue;
      }

      const seasonType = comp.season?.type;
      dbg(`SeasonType = ${seasonType}`, "#ccccff");

      if (![2, 3, 4].includes(seasonType)) {
        dbg("Filtered out", "#ffaa00");
        dbgGroupEnd();
        continue;
      }

      const teams = comp.competitors || [];
      const away = teams.find(t => t.homeAway === "away");
      const home = teams.find(t => t.homeAway === "home");

      if (!away || !home) {
        dbg("Missing teams", "#ff4444");
        dbgGroupEnd();
        continue;
      }

      const awayRec = null;
      const homeRec = null;

      away.record = awayRec;
      home.record = homeRec;

      const aPct = winPct(away);
      const hPct = winPct(home);
      const score = anticipation(aPct, hPct);

      allGames.push({
        league: lg.code,
        away,
        home,
        score,
        rawDate: ev.date,
        pst: formatPST(ev.date),
        playoff: seasonType >= 3,
        playoffRound: comp.notes?.[0]?.headline || "Playoffs"
      });

      dbgGroupEnd();
    }

    dbgGroupEnd();
  }

  dbg(`ESPN total games: ${allGames.length}`, "#00ffff");
  dbgGroupEnd();
  return allGames;
}

// 3. HYBRID MERGE
async function fetchHybridGames() {
  dbgGroup("HYBRID FETCH START");

  const [cbsPlayoffs, espnGames] = await Promise.all([
    fetchPlayoffGamesFromCBS(),
    fetchRegularGamesFromESPN()
  ]);

  dbg(`CBS playoff count: ${cbsPlayoffs.length}`, "#ff66ff");
  dbg(`ESPN total count: ${espnGames.length}`, "#66ff66");

  const playoffGames = cbsPlayoffs.length
    ? cbsPlayoffs
    : espnGames.filter(g => g.playoff);

  const regularGames = espnGames.filter(g => !g.playoff);

  playoffGames.sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));
  regularGames.sort((a, b) => b.score - a.score);

  const combined = [...playoffGames, ...regularGames];

  dbg(`HYBRID FINAL COUNT = ${combined.length}`, "#00ffff");
  dbgGroupEnd();

  return combined.slice(0, TOP_N);
}

// ============================================================
// RENDERING + ANIMATION
// ============================================================

dbgGroup("CHUNK 3 LOADED — Rendering + Animation");

function buildHTML(games) {
  dbgGroup("BUILDING HTML FOR GAMES");
  dbg(`Games received: ${games.length}`, "#00ffff");

  const html = games.map((g, i) => {
    dbg(`Game ${i + 1}: ${g.away.team.abbreviation} vs ${g.home.team.abbreviation}`, "#ccccff");

    const lc = leagueColors[g.league] || "#222";

    return `
      <span class="game-pill" style="background:${lc}; padding:6px 12px; margin-right:12px; border-radius:6px; display:inline-flex; align-items:center;">
        ${g.away.team.abbreviation}
        <span style="margin:0 8px;">vs</span>
        ${g.home.team.abbreviation}
        <span style="margin-left:12px; opacity:0.8;">${g.pst}</span>
      </span>
    `;
  }).join("");

  dbg("HTML build complete", "#00ff00");
  dbgGroupEnd();
  return html;
}

function startLoop() {
  dbgGroup("STARTING SCROLL LOOP");

  const ticker = document.getElementById("ticker");
  if (!ticker) {
    dbg("ERROR: #ticker not found", "#ff4444");
    dbgGroupEnd();
    return;
  }

  ticker.style.animation = "none";
  ticker.style.opacity = "0";

  void ticker.offsetWidth;

  const scrollSeconds = SCROLL_DURATION / 1000;
  dbg(`Scroll duration: ${scrollSeconds}s`, "#ccccff");

  ticker.style.animation =
    `fadeIn 0.4s ease forwards, scroll ${scrollSeconds}s linear forwards`;

  dbg("Scroll animation applied", "#00ff00");

  if (window.loopTimeout) clearTimeout(window.loopTimeout);

  window.loopTimeout = setTimeout(() => {
    dbg("Loop timeout reached — restarting loop", "#ffaa00");
    startLoop();
  }, SCROLL_DURATION + LOOP_PAUSE);

  dbgGroupEnd();
}

function render(games, isRefresh = false) {
  dbgGroup("RENDER() CALLED");

  const wrap = document.getElementById("tickerWrap");
  const ticker = document.getElementById("ticker");

  if (!wrap || !ticker) {
    dbg("ERROR: tickerWrap or ticker missing", "#ff4444");
    dbgGroupEnd();
    return;
  }

  dbg(`Rendering ${games.length} games`, "#00ffff");

  if (!games.length) {
    dbg("NO GAMES FOUND — showing fallback message", "#ffaa00");
    wrap.classList.remove("hidden");
    ticker.innerHTML = "No upcoming games found.";
    ticker.style.opacity = "1";
    ticker.style.animation = "none";
    dbgGroupEnd();
    return;
  }

  const newHTML = buildHTML(games);

  if (isRefresh) {
    dbg("Crossfade refresh triggered", "#ff66ff");
    wrap.classList.add("hidden");

    setTimeout(() => {
      ticker.innerHTML = newHTML;
      wrap.classList.remove("hidden");
      startLoop();
    }, 800);
  } else {
    dbg("Initial render", "#00ff00");
    wrap.classList.remove("hidden");
    ticker.innerHTML = newHTML;
    startLoop();
  }

  dbgGroupEnd();
}

dbgGroupEnd();

// ============================================================
// INIT + MAIN LOOP
// ============================================================

dbgGroup("CHUNK 4 LOADED — Init + Main Loop");

async function run(isRefresh = false) {
  dbgGroup(`RUN() CALLED — isRefresh=${isRefresh}`);

  try {
    dbg("Calling fetchHybridGames()…", "#4da6ff");
    const games = await fetchHybridGames();

    dbg(`fetchHybridGames() returned ${games.length} games`, "#00ffff");

    render(games, isRefresh);
  } catch (e) {
    dbg(`ERROR in run(): ${e}`, "#ff4444");
  }

  dbgGroupEnd();
}

function init() {
  dbgGroup("INIT() CALLED");

  dbg("Running initial fetch…", "#4da6ff");
  run(false);

  dbg(`Setting refresh interval: ${REFRESH_INTERVAL / 60000} minutes`, "#ccccff");

  if (window.refreshIntervalId) clearInterval(window.refreshIntervalId);

  window.refreshIntervalId = setInterval(() => {
    dbg("Refresh interval reached — running refresh", "#ffaa00");
    run(true);
  }, REFRESH_INTERVAL);

  dbgGroupEnd();
}

dbg("Calling init() to start ticker…", "#00ff00");
init();

dbgGroupEnd();
</script>
</body>
</html>
