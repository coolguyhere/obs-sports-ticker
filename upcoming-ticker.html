<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Top Games This Week</title>
<style>
/* ============================
   TICKER LAYOUT
   ============================ */

#tickerWrap {
  width: 100%;
  overflow: hidden;
  position: relative;
  background: #000;
  padding: 10px 0;
}

#ticker {
  white-space: nowrap;
  display: inline-block;
  opacity: 0;
  font-family: Arial, sans-serif;
  font-size: 20px;
  color: #fff;
}

/* Label above ticker */
.ticker-label {
  font-family: Arial, sans-serif;
  font-size: 22px;
  font-weight: bold;
  color: #fff;
  margin-bottom: 8px;
}

/* ============================
   GAME PILLS
   ============================ */

.game-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 14px;
  margin-right: 18px;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  gap: 10px;
}

/* Logos inside pills */
.game-pill img {
  height: 22px;
  width: 22px;
  object-fit: contain;
}

/* League color defaults (regular season) */
.league-NFL { background: #013369; }
.league-NBA { background: #17408B; }
.league-NHL { background: #111111; }
.league-MLB { background: #002D72; }

/* ============================
   PLAYOFF GRADIENT PILLS
   ============================ */

.playoff-pill {
  background: linear-gradient(to right, var(--awayColor), var(--homeColor));
  border: 1px solid rgba(255,255,255,0.25);
}

/* ============================
   ANIMATIONS
   ============================ */

@keyframes scroll {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ============================
   DEBUG PANEL
   ============================ */

#debugPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 45vh;
  background: rgba(0,0,0,0.85);
  color: #00ffea;
  font-family: Consolas, monospace;
  font-size: 13px;
  overflow-y: auto;
  z-index: 999999;
  padding: 10px;
  box-sizing: border-box;
  white-space: pre-wrap;
  border-top: 2px solid #00ffea;
}
</style>
</head>
<body>

<div class="ticker-wrap" id="tickerWrap">
  <div class="ticker-label">Top Games This Week</div>
  <div class="ticker" id="ticker">Loading upcoming games…</div>
</div>

<script>
// ============================================================
// DEBUG PANEL
// ============================================================

const debugPanel = document.createElement("div");
debugPanel.id = "debugPanel";
document.body.appendChild(debugPanel);

function dbg(msg, color = "#00ffea") {
  const line = document.createElement("div");
  line.style.color = color;
  line.textContent = msg;
  debugPanel.appendChild(line);
  debugPanel.scrollTop = debugPanel.scrollHeight;
  console.log(`%c${msg}`, `color:${color}`);
}

function dbgGroup(title) {
  dbg(`\n▼ ${title}`, "#4da6ff");
  console.group(title);
}
function dbgGroupEnd() {
  console.groupEnd();
  dbg(`▲ END GROUP`, "#4da6ff");
}

// ============================================================
// CONFIG
// ============================================================

dbgGroup("CONFIG LOADED");

const PROXY = "https://api.codetabs.com/v1/proxy/?quest=";

const leagues = [
  { code: "NFL", sport: "football", league: "nfl" },
  { code: "NBA", sport: "basketball", league: "nba" },
  { code: "NHL", sport: "hockey", league: "nhl" },
  { code: "MLB", sport: "baseball", league: "mlb" }
];

const leagueColors = {
  NFL: "#013369",
  NBA: "#17408B",
  NHL: "#111111",
  MLB: "#002D72"
};

const TOP_N = 5;
const LOOP_PAUSE = 1500;
const REFRESH_INTERVAL = 10 * 60 * 1000;
const SCROLL_DURATION = 70000;

dbg("Config loaded successfully", "#00ff00");
dbgGroupEnd();

// ============================================================
// UTILITIES
// ============================================================

dbgGroup("UTILITY FUNCTIONS LOADED");

function formatPST(iso) {
  try {
    const d = new Date(iso);

    // Convert to PST parts using toLocaleString
    const pstString = d.toLocaleString("en-US", {
      timeZone: "America/Los_Angeles",
      month: "numeric",   // 1–12, no leading zero
      day: "numeric",     // 1–31, no leading zero
      hour: "numeric",
      minute: "2-digit",
      hour12: true
    });

    // pstString will look like "1/12/2025, 1:15 PM"
    const [datePart, timePart] = pstString.split(", ");
    const [month, day] = datePart.split("/");

    // Return "M/D h:mm AM/PM"
    return `${Number(month)}/${Number(day)} ${timePart}`;
  } catch {
    return "";
  }
}

function winPct(team) {
  try {
    const rec = team.record?.items?.find(r => r.type === "total");
    if (!rec || !rec.summary) return 0.5;
    const [w, l] = rec.summary.split("-").map(Number);
    return w + l === 0 ? 0.5 : w / (w + l);
  } catch {
    return 0.5;
  }
}

function anticipation(a, b) {
  return (a + b) / 2 - Math.abs(a - b);
}

// Helper: is this a special event (playoff / tournament / final)?
function isSpecialEvent(game) {
  const stage = (game.stage || game.playoffRound || "").toLowerCase();

  return (
    game.playoff === true ||
    game.tournament === true ||
    /round|final|playoff|cup|bowl|championship/.test(stage)
  );
}

dbg("Utility functions loaded", "#00ff00");
dbgGroupEnd();
// ============================================================
// TEAM DIRECTORY CACHE (LOGOS + COLORS)
// ============================================================

const TEAM_CACHE = {
  NFL: {},
  NBA: {},
  NHL: {},
  MLB: {}
};

async function loadTeamDirectory(lg) {
  dbgGroup(`Loading ESPN team directory for ${lg.code}`);

  const url =
    `https://sports.core.api.espn.com/v2/sports/${lg.sport}/leagues/${lg.league}/teams`;

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const data = await res.json();

    if (!data.items) {
      dbg("No team directory items", "#ffaa00");
      dbgGroupEnd();
      return;
    }

    for (const item of data.items) {
      try {
        const tRes = await fetch(PROXY + encodeURIComponent(item.$ref));
        const tData = await tRes.json();

        const id = tData.id;
        const name = tData.name?.toLowerCase() || "";
        const abbr = tData.abbreviation || "";
        const logo = tData.logos?.[0]?.href || "";
        const color = tData.color ? `#${tData.color}` : "#444";

        TEAM_CACHE[lg.code][name] = {
          id,
          name,
          abbr,
          logo,
          color
        };

      } catch (e) {
        dbg(`Error loading team: ${e}`, "#ff4444");
      }
    }

    dbg(`Loaded ${Object.keys(TEAM_CACHE[lg.code]).length} teams`, "#00ff00");
  } catch (e) {
    dbg(`Team directory fetch error: ${e}`, "#ff4444");
  }

  dbgGroupEnd();
}

function normalizeName(name) {
  return name
    .toLowerCase()
    .replace(/city|fc|sc|club|team/gi, "")
    .replace(/[^a-z\s]/g, "")
    .trim();
}

function findTeam(lgCode, rawName) {
  const norm = normalizeName(rawName);
  const teams = TEAM_CACHE[lgCode];

  for (const key in teams) {
    if (key.includes(norm) || norm.includes(key)) {
      return teams[key];
    }
  }
  return null;
}

// ============================================================
// CBS PLAYOFF SCRAPER
// ============================================================

async function fetchPlayoffGamesFromCBS() {
  dbgGroup("CBS PLAYOFF FETCH");

  const url = "https://www.cbssports.com/nfl/schedule/playoffs/";
  dbg(`CBS URL: ${url}`, "#4da6ff");

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    let rows = doc.querySelectorAll("table tr");

    if (rows.length === 0) {
      rows = doc.querySelectorAll(".TableBase-body .TableBase-bodyTr");
    }

    dbg(`CBS rows found: ${rows.length}`, "#ccccff");

    const games = [];

    rows.forEach(row => {
      const cells = row.querySelectorAll("td, .TableBase-bodyTd");
      if (cells.length < 3) return;

      const dateText = cells[0].textContent.trim();
      const timeText = cells[1].textContent.trim();
      const matchupText = cells[2].textContent.trim();

      if (!matchupText.includes("at") && !matchupText.includes("@")) return;

      let [awayName, homeName] = matchupText.split(/at|@/i).map(s => s.trim());

      const rawString = `${dateText} ${timeText} PST`;
      const rawDate = new Date(rawString);
      const iso = rawDate.toISOString();

      games.push({
        league: "NFL",
        playoff: true,
        playoffRound: "Playoffs",
        rawDate: iso,
        pst: formatPST(iso),
        score: 1.0,
        away: { rawName: awayName },
        home: { rawName: homeName }
      });
    });

    dbg(`CBS parsed playoff games: ${games.length}`, "#ff66ff");
    dbgGroupEnd();
    return games;

  } catch (e) {
    dbg(`CBS ERROR: ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

// ============================================================
// SPORTING NEWS FALLBACK
// ============================================================

async function fetchPlayoffsFromSportingNews() {
  dbgGroup("SPORTING NEWS FALLBACK");

  const url = "https://www.sportingnews.com/us/nfl/schedule";
  dbg(`SN URL: ${url}`, "#4da6ff");

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const rows = doc.querySelectorAll("table tr");
    dbg(`SN rows found: ${rows.length}`, "#ccccff");

    const games = [];

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 3) return;

      const dateText = cells[0].textContent.trim();
      const matchupText = cells[1].textContent.trim();
      const timeText = cells[2].textContent.trim();

      if (!matchupText.includes("at") && !matchupText.includes("@")) return;

      let [awayName, homeName] = matchupText.split(/at|@/i).map(s => s.trim());

      const rawString = `${dateText} ${timeText} PST`;
      const rawDate = new Date(rawString);
      const iso = rawDate.toISOString();

      games.push({
        league: "NFL",
        playoff: true,
        playoffRound: "Playoffs",
        rawDate: iso,
        pst: formatPST(iso),
        score: 1.0,
        away: { rawName: awayName },
        home: { rawName: homeName }
      });
    });

    dbg(`SN parsed playoff games: ${games.length}`, "#ff66ff");
    dbgGroupEnd();
    return games;

  } catch (e) {
    dbg(`SN ERROR: ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

// ============================================================
// ESPN REGULAR SEASON FETCH
// ============================================================

async function fetchRegularGamesFromESPN() {
  dbgGroup("ESPN REGULAR FETCH");

  const allGames = [];

  for (const lg of leagues) {
    dbgGroup(`ESPN League: ${lg.code}`);

    const season = new Date().getFullYear();

    const now = new Date();
    const end = new Date(now.getTime() + 30 * 86400000);

    const startStr = now.toISOString().slice(0, 10).replace(/-/g, "");
    const endStr = end.toISOString().slice(0, 10).replace(/-/g, "");

    const scheduleURL =
      `https://sports.core.api.espn.com/v2/sports/${lg.sport}/` +
      `leagues/${lg.league}/seasons/${season}/events?dates=${startStr}-${endStr}`;

    dbg(`ESPN URL: ${scheduleURL}`, "#4da6ff");

    let scheduleData;
    try {
      const res = await fetch(PROXY + encodeURIComponent(scheduleURL));
      scheduleData = await res.json();
      dbg("ESPN schedule OK", "#00ff00");
    } catch (e) {
      dbg(`ESPN ERROR: ${e}`, "#ff4444");
      dbgGroupEnd();
      continue;
    }

    if (!scheduleData.items?.length) {
      dbg("ESPN returned NO items", "#ffaa00");
      dbgGroupEnd();
      continue;
    }

    for (const item of scheduleData.items) {
      let ev;
      try {
        const evRes = await fetch(PROXY + encodeURIComponent(item.$ref));
        ev = await evRes.json();
      } catch {
        continue;
      }

      const comp = ev.competitions?.[0];
      if (!comp) continue;

      const seasonType = comp.season?.type;
      if (![2, 3, 4].includes(seasonType)) continue;

      const teams = comp.competitors || [];
      const away = teams.find(t => t.homeAway === "away");
      const home = teams.find(t => t.homeAway === "home");

      if (!away || !home) continue;

      const aPct = winPct(away);
      const hPct = winPct(home);
      const score = anticipation(aPct, hPct);

      allGames.push({
        league: lg.code,
        away: {
          rawName: away.team?.displayName || "",
          id: away.id
        },
        home: {
          rawName: home.team?.displayName || "",
          id: home.id
        },
        score,
        rawDate: ev.date,
        pst: formatPST(ev.date),
        playoff: seasonType >= 3,
        playoffRound: comp.notes?.[0]?.headline || "Playoffs"
      });
    }

    dbgGroupEnd();
  }

  dbg(`ESPN total games: ${allGames.length}`, "#00ffff");
  dbgGroupEnd();
  return allGames;
}
// ============================================================
// NFL.COM PLAYOFF FETCH (ALL ROUNDS POST-1 → POST-4)
// ============================================================

// Determine NFL season year dynamically
// Jan–Feb → last season, Mar–Dec → current year
function getNFLSeasonYear() {
  if (FORCE_TEST_SEASON) return TEST_SEASON_YEAR;

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  // Jan–Feb belong to last season
  return month <= 2 ? year - 1 : year;
}

async function fetchPlayoffsFromNFLWeek(weekNumber) {
  dbgGroup(`NFL.COM PLAYOFF FETCH — WEEK post-${weekNumber}`);

  const seasonYear = getNFLSeasonYear();
  const url = `https://www.nfl.com/schedules/${seasonYear}/by-week/post-${weekNumber}`;
  dbg(`NFL.com URL: ${url}`, "#4da6ff");

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    // Each matchup strip = one game
    const strips = doc.querySelectorAll(".nfl-c-matchup-strip");
    dbg(`NFL.com matchup strips found: ${strips.length}`, "#ccccff");

    const games = [];

    strips.forEach(strip => {
      try {
        const teamEls = strip.querySelectorAll(".nfl-c-matchup-strip__team-fullname");
        if (teamEls.length < 2) return;

        const awayName = teamEls[0].textContent.trim();
        const homeName = teamEls[1].textContent.trim();

        const dateEl = strip.querySelector(".nfl-c-matchup-strip__date");
        const timeEl = strip.querySelector(".nfl-c-matchup-strip__time");
        const networkEl = strip.querySelector(".nfl-c-matchup-strip__network");

        const dateText = dateEl ? dateEl.textContent.trim() : "";
        const timeText = timeEl ? timeEl.textContent.trim() : "";
        const networkText = networkEl ? networkEl.textContent.trim() : "";

        if (!dateText || !timeText) return;

        // dateText example: "Sun, Jan 12"
        // Build a parseable string with season-year + ET
        const seasonYearStr = String(getNFLSeasonYear());
        const rawString = `${dateText} ${seasonYearStr} ${timeText} ET`;

        const rawDate = new Date(rawString);
        const iso = rawDate.toISOString();

        // Map week → round label
        let roundLabel = "";
        switch (weekNumber) {
          case 1:
            roundLabel = "Wild Card";
            break;
          case 2:
            roundLabel = "Divisional";
            break;
          case 3:
            roundLabel = "Conference Championship";
            break;
          case 4:
            roundLabel = "Super Bowl";
            break;
          default:
            roundLabel = "Playoffs";
        }

        games.push({
          league: "NFL",
          playoff: true,
          playoffRound: roundLabel,
          rawDate: iso,
          pst: formatPST(iso),        // will be "M/D h:mm AM/PM"
          network: networkText,       // e.g., "CBS"
          score: 1.0,                 // high priority
          away: { rawName: awayName },
          home: { rawName: homeName }
        });
      } catch (err) {
        dbg(`NFL.com strip parse error: ${err}`, "#ff4444");
      }
    });

    dbg(`NFL.com parsed playoff games (post-${weekNumber}): ${games.length}`, "#ff66ff");
    dbgGroupEnd();
    return games;

  } catch (e) {
    dbg(`NFL.com FETCH ERROR (post-${weekNumber}): ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

async function fetchAllNFLPlayoffs() {
  dbgGroup("NFL.COM ALL PLAYOFF ROUNDS");

  // post-1 → Wild Card, post-2 → Divisional, post-3 → Conf Champ, post-4 → SB
  const results = await Promise.all([
    fetchPlayoffsFromNFLWeek(1),
    fetchPlayoffsFromNFLWeek(2),
    fetchPlayoffsFromNFLWeek(3),
    fetchPlayoffsFromNFLWeek(4)
  ]);

  const allGames = results.flat();
  allGames.sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));

  dbg(`NFL.com total playoff games: ${allGames.length}`, "#00ffff");
  dbgGroupEnd();

  return allGames;
}
// ============================================================
// HYBRID MERGE — NFL.com → CBS → SN → ESPN
// ============================================================

async function fetchHybridGames() {
  dbgGroup("HYBRID FETCH START");

  // Load ESPN team directories first (logos + colors)
  for (const lg of leagues) {
    await loadTeamDirectory(lg);
  }

  // Fetch all sources in parallel
  const [
    nflPlayoffs,
    cbsPlayoffs,
    snPlayoffs,
    espnGames
  ] = await Promise.all([
    fetchAllNFLPlayoffs(),          // NEW TOP PRIORITY
    fetchPlayoffGamesFromCBS(),
    fetchPlayoffsFromSportingNews(),
    fetchRegularGamesFromESPN()
  ]);

  dbg(`NFL.com playoff count: ${nflPlayoffs.length}`, "#66ffff");
  dbg(`CBS playoff count: ${cbsPlayoffs.length}`, "#ff66ff");
  dbg(`SN playoff count: ${snPlayoffs.length}`, "#ff66ff");
  dbg(`ESPN total count: ${espnGames.length}`, "#66ff66");

  // Determine playoff source priority
  let playoffGames = [];
  if (nflPlayoffs.length) playoffGames = nflPlayoffs;
  else if (cbsPlayoffs.length) playoffGames = cbsPlayoffs;
  else if (snPlayoffs.length) playoffGames = snPlayoffs;

  // Attach logos + colors
  function enrich(game) {
    const lg = game.league;

    const awayTeam = findTeam(lg, game.away.rawName);
    const homeTeam = findTeam(lg, game.home.rawName);

    game.away.team = {
      abbreviation: awayTeam?.abbr || game.away.rawName.slice(0, 3).toUpperCase(),
      logo: awayTeam?.logo || "",
      color: awayTeam?.color || "#444"
    };

    game.home.team = {
      abbreviation: homeTeam?.abbr || game.home.rawName.slice(0, 3).toUpperCase(),
      logo: homeTeam?.logo || "",
      color: homeTeam?.color || "#444"
    };

    return game;
  }

  playoffGames = playoffGames.map(enrich);
  const regularGames = espnGames.map(enrich);

  // Sort playoff games by date
  playoffGames.sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));

  // Sort regular season by anticipation score
  regularGames.sort((a, b) => b.score - a.score);

  const combined = [...playoffGames, ...regularGames];

  dbg(`HYBRID FINAL COUNT = ${combined.length}`, "#00ffff");
  dbgGroupEnd();

  return combined.slice(0, TOP_N);
}

function render(html) {
  const el = document.getElementById("ticker");
  if (el) el.innerHTML = html;
}
   
// ============================================================
// RENDERING — SPECIAL EVENT GRADIENT PILLS
// ============================================================

function buildHTML(games) {
  dbgGroup("BUILDING HTML FOR GAMES");

  const html = games.map(g => {
    const special = isSpecialEvent(g);

    const pillClass = special
      ? "game-pill playoff-pill"
      : `game-pill league-${g.league}`;

    const style = special
      ? `style="--awayColor:${g.away.team.color}; --homeColor:${g.home.team.color};"`
      : "";

    // Build the time + network string
    let timeString = g.pst; // already "M/D h:mm AM/PM"
    if (g.network) timeString += ` • ${g.network}`;

    return `
      <span class="${pillClass}" ${style}>
        <img src="${g.away.team.logo}" />
        ${g.away.team.abbreviation}
        <span style="margin:0 8px;">vs</span>
        ${g.home.team.abbreviation}
        <img src="${g.home.team.logo}" />
        <span style="margin-left:12px; opacity:0.85;">• ${timeString}</span>
      </span>
    `;
  }).join("");

  dbgGroupEnd();
  return html;
}

// ============================================================
// INIT + MAIN LOOP
// ============================================================

dbgGroup("CHUNK 4 LOADED — Init + Main Loop");

async function run(isRefresh = false) {
  dbgGroup(`RUN() CALLED — isRefresh=${isRefresh}`);

  try {
    const games = await fetchHybridGames();
    render(games, isRefresh);
  } catch (e) {
    dbg(`ERROR in run(): ${e}`, "#ff4444");
  }

  dbgGroupEnd();
}

function init() {
  dbgGroup("INIT() CALLED");

  run(false);

  if (window.refreshIntervalId) clearInterval(window.refreshIntervalId);

  window.refreshIntervalId = setInterval(() => {
    run(true);
  }, REFRESH_INTERVAL);

  dbgGroupEnd();
}

init();
dbgGroupEnd();
</script>
</body>
</html>
