<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Top Games This Week</title>
<style>
/* ============================
   TICKER LAYOUT
   ============================ */
.round-header {
  font-weight: 700;
  font-size: 14px;
  margin: 12px 0 4px;
  opacity: 0.9;
}

.live-badge {
  background: red;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  margin-right: 6px;
}
   
#tickerWrap {
  width: 100%;
  overflow: hidden;
  position: relative;
  background: #000;
  padding: 10px 0;
}

#ticker {
  white-space: nowrap;
  display: inline-block;
  opacity: 0;
  font-family: Arial, sans-serif;
  font-size: 20px;
  color: #fff;
}

/* Label above ticker */
.ticker-label {
  font-family: Arial, sans-serif;
  font-size: 22px;
  font-weight: bold;
  color: #fff;
  margin-bottom: 8px;
}

/* ============================
   GAME PILLS
   ============================ */

.game-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 14px;
  margin-right: 18px;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  gap: 10px;
}

/* Logos inside pills */
.game-pill img {
  height: 22px;
  width: 22px;
  object-fit: contain;
}

/* League color defaults (regular season) */
.league-NFL { background: #013369; }
.league-NBA { background: #17408B; }
.league-NHL { background: #111111; }
.league-MLB { background: #002D72; }

/* ============================
   PLAYOFF GRADIENT PILLS
   ============================ */

.playoff-pill {
  background: linear-gradient(to right, var(--awayColor), var(--homeColor));
  border: 1px solid rgba(255,255,255,0.25);
}

/* ============================
   ANIMATIONS
   ============================ */

@keyframes scroll {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ============================
   DEBUG PANEL
   ============================ */

#debugPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 45vh;
  background: rgba(0,0,0,0.85);
  color: #00ffea;
  font-family: Consolas, monospace;
  font-size: 13px;
  overflow-y: auto;
  z-index: 999999;
  padding: 10px;
  box-sizing: border-box;
  white-space: pre-wrap;
  border-top: 2px solid #00ffea;
}
</style>
</head>
<body>

<div class="ticker-wrap" id="tickerWrap">
  <div class="ticker-label">Top Games This Week</div>
  <div class="ticker" id="ticker">Loading upcoming games…</div>
</div>

<script>
// ============================================================
// DEBUG PANEL
// ============================================================
// TEMPORARY: force NFL.com to use 2024 season for testing
const FORCE_TEST_SEASON = true;
const TEST_SEASON_YEAR = 2024;

const debugPanel = document.createElement("div");
debugPanel.id = "debugPanel";
document.body.appendChild(debugPanel);

function dbg(msg, color = "#00ffea") {
  const line = document.createElement("div");
  line.style.color = color;
  line.textContent = msg;
  debugPanel.appendChild(line);
  debugPanel.scrollTop = debugPanel.scrollHeight;
  console.log(`%c${msg}`, `color:${color}`);
}

function dbgGroup(title) {
  dbg(`\n▼ ${title}`, "#4da6ff");
  console.group(title);
}
function dbgGroupEnd() {
  console.groupEnd();
  dbg(`▲ END GROUP`, "#4da6ff");
}

// ============================================================
// CONFIG
// ============================================================

dbgGroup("CONFIG LOADED");

const PROXY = "https://api.codetabs.com/v1/proxy/?quest=";

const leagues = [
  { code: "NFL", sport: "football", league: "nfl" },
  { code: "NBA", sport: "basketball", league: "nba" },
  { code: "NHL", sport: "hockey", league: "nhl" },
  { code: "MLB", sport: "baseball", league: "mlb" }
];

const leagueColors = {
  NFL: "#013369",
  NBA: "#17408B",
  NHL: "#111111",
  MLB: "#002D72"
};

const TOP_N = 5;
const LOOP_PAUSE = 1500;
// Auto-refresh every 5 minutes
const REFRESH_INTERVAL = 5 * 60 * 1000;
const SCROLL_DURATION = 70000;

dbg("Config loaded successfully", "#00ff00");
dbgGroupEnd();

// ============================================================
// UTILITIES
// ============================================================

dbgGroup("UTILITY FUNCTIONS LOADED");

function formatPST(iso) {
  try {
    const d = new Date(iso);

    const pstString = d.toLocaleString("en-US", {
      timeZone: "America/Los_Angeles",
      month: "numeric",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit",
      hour12: true
    });

    const [datePart, timePart] = pstString.split(", ");
    const [month, day] = datePart.split("/");

    return `${Number(month)}/${Number(day)} ${timePart}`;
  } catch {
    return "";
  }
}

function winPct(team) {
  try {
    const rec = team.record?.items?.find(r => r.type === "total");
    if (!rec || !rec.summary) return 0.5;
    const [w, l] = rec.summary.split("-").map(Number);
    return w + l === 0 ? 0.5 : w / (w + l);
  } catch {
    return 0.5;
  }
}

function anticipation(a, b) {
  return (a + b) / 2 - Math.abs(a - b);
}

// Helper: is this a special event (playoff / tournament / final)?
function isSpecialEvent(game) {
  const stage = (game.stage || game.playoffRound || "").toLowerCase();

  return (
    game.playoff === true ||
    game.tournament === true ||
    /round|final|playoff|cup|bowl|championship/.test(stage)
  );
}

// Helper: is this game in progress? (simple 3-hour window around start)
function isInProgress(game) {
  try {
    const now = Date.now();
    const start = new Date(game.rawDate).getTime();
    const end = start + 3 * 60 * 60 * 1000;
    return now >= start && now <= end;
  } catch {
    return false;
  }
}

dbg("Utility functions loaded", "#00ff00");
dbgGroupEnd();

// ============================================================
// TEAM DIRECTORY CACHE (LOGOS + COLORS)
// ============================================================

const TEAM_CACHE = {
  NFL: {},
  NBA: {},
  NHL: {},
  MLB: {}
};

async function loadTeamDirectory(lg) {
  dbgGroup(`Loading ESPN team directory for ${lg.code}`);

  const url =
    `https://sports.core.api.espn.com/v2/sports/${lg.sport}/leagues/${lg.league}/teams`;

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const data = await res.json();

    if (!data.items) {
      dbg("No team directory items", "#ffaa00");
      dbgGroupEnd();
      return;
    }

    for (const item of data.items) {
      try {
        const tRes = await fetch(PROXY + encodeURIComponent(item.$ref));
        const tData = await tRes.json();

        const id = tData.id;
        const name = tData.name?.toLowerCase() || "";
        const abbr = tData.abbreviation || "";
        const logo = tData.logos?.[0]?.href || "";
        const color = tData.color ? `#${tData.color}` : "#444";

        TEAM_CACHE[lg.code][name] = {
          id,
          name,
          abbr,
          logo,
          color
        };

      } catch (e) {
        dbg(`Error loading team: ${e}`, "#ff4444");
      }
    }

    dbg(`Loaded ${Object.keys(TEAM_CACHE[lg.code]).length} teams`, "#00ff00");
  } catch (e) {
    dbg(`Team directory fetch error: ${e}`, "#ff4444");
  }

  dbgGroupEnd();
}

function normalizeName(name) {
  return name
    .toLowerCase()
    .replace(/city|fc|sc|club|team/gi, "")
    .replace(/[^a-z\s]/g, "")
    .trim();
}

function findTeam(lgCode, rawName) {
  const norm = normalizeName(rawName);
  const teams = TEAM_CACHE[lgCode];

  for (const key in teams) {
    if (key.includes(norm) || norm.includes(key)) {
      return teams[key];
    }
  }
  return null;
}

// ============================================================
// CBS PLAYOFF SCRAPER
// ============================================================

async function fetchPlayoffGamesFromCBS() {
  dbgGroup("CBS PLAYOFF FETCH");

  const url = "https://www.cbssports.com/nfl/schedule/playoffs/";
  dbg(`CBS URL: ${url}`, "#4da6ff");

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    let rows = doc.querySelectorAll("table tr");

    if (rows.length === 0) {
      rows = doc.querySelectorAll(".TableBase-body .TableBase-bodyTr");
    }

    dbg(`CBS rows found: ${rows.length}`, "#ccccff");

    const games = [];

    rows.forEach(row => {
      const cells = row.querySelectorAll("td, .TableBase-bodyTd");
      if (cells.length < 3) return;

      const dateText = cells[0].textContent.trim();
      const timeText = cells[1].textContent.trim();
      const matchupText = cells[2].textContent.trim();

      if (!matchupText.includes("at") && !matchupText.includes("@")) return;

      let [awayName, homeName] = matchupText.split(/at|@/i).map(s => s.trim());

      const rawString = `${dateText} ${timeText} PST`;
      const rawDate = new Date(rawString);
      const iso = rawDate.toISOString();

      games.push({
        league: "NFL",
        playoff: true,
        playoffRound: "Playoffs",
        rawDate: iso,
        pst: formatPST(iso),
        score: 1.0,
        away: { rawName: awayName },
        home: { rawName: homeName }
      });
    });

    dbg(`CBS parsed playoff games: ${games.length}`, "#ff66ff");
    dbgGroupEnd();
    return games;

  } catch (e) {
    dbg(`CBS ERROR: ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

// ============================================================
// SPORTING NEWS FALLBACK
// ============================================================

async function fetchPlayoffsFromSportingNews() {
  dbgGroup("SPORTING NEWS FALLBACK");

  const url = "https://www.sportingnews.com/us/nfl/schedule";
  dbg(`SN URL: ${url}`, "#4da6ff");

  try {
    const res = await fetch(PROXY + encodeURIComponent(url));
    const html = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");

    const rows = doc.querySelectorAll("table tr");
    dbg(`SN rows found: ${rows.length}`, "#ccccff");

    const games = [];

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 3) return;

      const dateText = cells[0].textContent.trim();
      const matchupText = cells[1].textContent.trim();
      const timeText = cells[2].textContent.trim();

      if (!matchupText.includes("at") && !matchupText.includes("@")) return;

      let [awayName, homeName] = matchupText.split(/at|@/i).map(s => s.trim());

      const rawString = `${dateText} ${timeText} PST`;
      const rawDate = new Date(rawString);
      const iso = rawDate.toISOString();

      games.push({
        league: "NFL",
        playoff: true,
        playoffRound: "Playoffs",
        rawDate: iso,
        pst: formatPST(iso),
        score: 1.0,
        away: { rawName: awayName },
        home: { rawName: homeName }
      });
    });

    dbg(`SN parsed playoff games: ${games.length}`, "#ff66ff");
    dbgGroupEnd();
    return games;

  } catch (e) {
    dbg(`SN ERROR: ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

// ============================================================
// ESPN REGULAR SEASON FETCH
// ============================================================

async function fetchRegularGamesFromESPN() {
  dbgGroup("ESPN REGULAR FETCH");

  const allGames = [];

  for (const lg of leagues) {
    dbgGroup(`ESPN League: ${lg.code}`);

    const season = new Date().getFullYear();

    const now = new Date();
    const end = new Date(now.getTime() + 30 * 86400000);

    const startStr = now.toISOString().slice(0, 10).replace(/-/g, "");
    const endStr = end.toISOString().slice(0, 10).replace(/-/g, "");

    const scheduleURL =
      `https://sports.core.api.espn.com/v2/sports/${lg.sport}/` +
      `leagues/${lg.league}/seasons/${season}/events?dates=${startStr}-${endStr}`;

    dbg(`ESPN URL: ${scheduleURL}`, "#4da6ff");

    let scheduleData;
    try {
      const res = await fetch(PROXY + encodeURIComponent(scheduleURL));
      scheduleData = await res.json();
      dbg("ESPN schedule OK", "#00ff00");
    } catch (e) {
      dbg(`ESPN ERROR: ${e}`, "#ff4444");
      dbgGroupEnd();
      continue;
    }

    if (!scheduleData.items?.length) {
      dbg("ESPN returned NO items", "#ffaa00");
      dbgGroupEnd();
      continue;
    }

    for (const item of scheduleData.items) {
      let ev;
      try {
        const evRes = await fetch(PROXY + encodeURIComponent(item.$ref));
        ev = await evRes.json();
      } catch {
        continue;
      }

      const comp = ev.competitions?.[0];
      if (!comp) continue;

      const seasonType = comp.season?.type;
      if (![2, 3, 4].includes(seasonType)) continue;

      const teams = comp.competitors || [];
      const away = teams.find(t => t.homeAway === "away");
      const home = teams.find(t => t.homeAway === "home");

      if (!away || !home) continue;

      const aPct = winPct(away);
      const hPct = winPct(home);
      const score = anticipation(aPct, hPct);

      allGames.push({
        league: lg.code,
        away: {
          rawName: away.team?.displayName || "",
          id: away.id
        },
        home: {
          rawName: home.team?.displayName || "",
          id: home.id
        },
        score,
        rawDate: ev.date,
        pst: formatPST(ev.date),
        playoff: seasonType >= 3,
        playoffRound: comp.notes?.[0]?.headline || "Playoffs"
      });
    }

    dbgGroupEnd();
  }

  dbg(`ESPN total games: ${allGames.length}`, "#00ffff");
  dbgGroupEnd();
  return allGames;
}

// ============================================================
// NFL.COM SEASON YEAR HELPER (WITH TEST OVERRIDE)
// ============================================================

function getNFLSeasonYear() {
  if (FORCE_TEST_SEASON) return TEST_SEASON_YEAR;

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  return month <= 2 ? year - 1 : year;
}

// ============================================================
// NFL.COM POSTSEASON SCRAPER (ALL ROUNDS IN ONE PAGE)
// ============================================================

// ============================================================
// ESPN SCOREBOARD POSTSEASON SCRAPER (REPLACES NFL.com POSTSEASON)
// ============================================================
async function fetchAllNFLPlayoffs() {
  dbgGroup("ESPN POSTSEASON FETCH (used as NFL playoff source)");

  const seasonYear = getNFLSeasonYear();
  const games = [];

  try {
    // ESPN uses seasontype=3 for postseason. We'll iterate week=1..6 to be safe.
    // (Some seasons use 1..4; 6 is a safe upper bound for any playoff structure.)
    for (let week = 1; week <= 6; week++) {
      const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?seasontype=3&season=${seasonYear}&week=${week}`;
      dbg(`ESPN postseason URL (week ${week}): ${url}`, "#4da6ff");

      let res, data;
      try {
        res = await fetch(PROXY + encodeURIComponent(url));
        data = await res.json();
      } catch (e) {
        dbg(`ESPN fetch error (week ${week}): ${e}`, "#ff4444");
        continue;
      }

      const events = data.events || [];
      dbg(`ESPN events found (week ${week}): ${events.length}`, "#ccccff");

      for (const ev of events) {
        try {
          const comp = ev.competitions?.[0];
          if (!comp) continue;

          // Round / headline: prefer competition.note or event.league?.name or comp.type
          const roundText =
            comp.notes?.[0]?.headline ||
            ev.league?.name ||
            comp.type?.text ||
            `Playoffs`;

          const iso = ev.date || comp.date || comp.time || null;
          if (!iso) continue;

          const competitors = comp.competitors || [];
          const away = competitors.find(c => c.homeAway === "away");
          const home = competitors.find(c => c.homeAway === "home");
          if (!away || !home) continue;

          // Broadcasts: comp.broadcasts or ev.broadcasts
          let network = "";
          const broadcasts = comp.broadcasts || ev.broadcasts || [];
          if (broadcasts.length) {
            // prefer national network entry
            const b = broadcasts.find(b => b.market === "national") || broadcasts[0];
            network = b.names ? b.names.join(", ") : (b.name || "");
          }

          games.push({
            league: "NFL",
            playoff: true,
            playoffRound: roundText,
            rawDate: ev.date || comp.date,
            pst: formatPST(ev.date || comp.date),
            network: network,
            score: 1.0,
            away: { rawName: away.team?.displayName || away.team?.name || away.team?.abbreviation || "" },
            home: { rawName: home.team?.displayName || home.team?.name || home.team?.abbreviation || "" }
          });
        } catch (err) {
          dbg(`ESPN event parse error: ${err}`, "#ff4444");
        }
      }
    }

    // Deduplicate by ISO + teams (in case multiple weeks return same game)
    const seen = new Set();
    const unique = [];
    for (const g of games) {
      const key = `${g.rawDate}|${g.away.rawName}|${g.home.rawName}`;
      if (!seen.has(key)) {
        seen.add(key);
        unique.push(g);
      }
    }

    // Sort by date
    unique.sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));

    dbg(`ESPN parsed playoff games: ${unique.length}`, "#00ffff");
    dbgGroupEnd();
    return unique;
  } catch (e) {
    dbg(`ESPN POSTSEASON FETCH ERROR: ${e}`, "#ff4444");
    dbgGroupEnd();
    return [];
  }
}

// ============================================================
// HYBRID MERGE — NFL.com → CBS → SN → ESPN
// ============================================================

async function fetchHybridGames() {
  dbgGroup("HYBRID FETCH START");

  // Load ESPN team directories first (logos + colors)
  for (const lg of leagues) {
    await loadTeamDirectory(lg);
  }

  const [
    nflPlayoffs,
    cbsPlayoffs,
    snPlayoffs,
    espnGames
  ] = await Promise.all([
    fetchAllNFLPlayoffs(),
    fetchPlayoffGamesFromCBS(),
    fetchPlayoffsFromSportingNews(),
    fetchRegularGamesFromESPN()
  ]);

  dbg(`NFL.com playoff count: ${nflPlayoffs.length}`, "#66ffff");
  dbg(`CBS playoff count: ${cbsPlayoffs.length}`, "#ff66ff");
  dbg(`SN playoff count: ${snPlayoffs.length}`, "#ff66ff");
  dbg(`ESPN total count: ${espnGames.length}`, "#66ff66");

  let playoffGames = [];
  if (nflPlayoffs.length) playoffGames = nflPlayoffs;
  else if (cbsPlayoffs.length) playoffGames = cbsPlayoffs;
  else if (snPlayoffs.length) playoffGames = snPlayoffs;

  function enrich(game) {
    const lg = game.league;

    const awayTeam = findTeam(lg, game.away.rawName);
    const homeTeam = findTeam(lg, game.home.rawName);

    game.away.team = {
      abbreviation: awayTeam?.abbr || game.away.rawName.slice(0, 3).toUpperCase(),
      logo: awayTeam?.logo || "",
      color: awayTeam?.color || "#444"
    };

    game.home.team = {
      abbreviation: homeTeam?.abbr || game.home.rawName.slice(0, 3).toUpperCase(),
      logo: homeTeam?.logo || "",
      color: homeTeam?.color || "#444"
    };

    return game;
  }

  playoffGames = playoffGames.map(enrich);
  const regularGames = espnGames.map(enrich);

  playoffGames.sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));
  regularGames.sort((a, b) => b.score - a.score);

  const combined = [...playoffGames, ...regularGames];

  dbg(`HYBRID FINAL COUNT = ${combined.length}`, "#00ffff");
  dbgGroupEnd();

  return combined.slice(0, TOP_N);
}

function render(html) {
  const el = document.getElementById("ticker");
  if (el) el.innerHTML = html;
}

// ============================================================
// RENDERING — SPECIAL EVENT GRADIENT PILLS + ROUND HEADERS + LIVE
// ============================================================

function buildHTML(games) {
  dbgGroup("BUILDING HTML FOR GAMES");

  const html = games.map((g, i) => {
    const special = isSpecialEvent(g);

    const pillClass = special
      ? "game-pill playoff-pill"
      : `game-pill league-${g.league}`;

    const style = special
      ? `style="--awayColor:${g.away.team.color}; --homeColor:${g.home.team.color};"`
      : "";

    // Round header
    const prev = games[i - 1];
    const showHeader = !prev || prev.playoffRound !== g.playoffRound;
    const header = showHeader
      ? `<div class="round-header">${g.playoffRound}</div>`
      : "";

    // LIVE badge
    const live = isInProgress(g);
    const liveBadge = live ? `<span class="live-badge">LIVE</span>` : "";

    let timeString = g.pst;
    if (g.network) timeString += ` • ${g.network}`;

    return `
      ${header}
      <span class="${pillClass}" ${style}>
        ${liveBadge}
        <img src="${g.away.team.logo}" />
        ${g.away.team.abbreviation}
        <span style="margin:0 8px;">vs</span>
        ${g.home.team.abbreviation}
        <img src="${g.home.team.logo}" />
        <span style="margin-left:12px; opacity:0.85;">• ${timeString}</span>
      </span>
    `;
  }).join("");

  dbgGroupEnd();
  return html;
}

// ============================================================
// INIT + MAIN LOOP
// ============================================================

dbgGroup("CHUNK 4 LOADED — Init + Main Loop");

async function run(isRefresh = false) {
  dbgGroup(`RUN() CALLED — isRefresh=${isRefresh}`);

  try {
    const games = await fetchHybridGames();
    const html = buildHTML(games);
    render(html);
  } catch (e) {
    dbg(`ERROR in run(): ${e}`, "#ff4444");
  }

  dbgGroupEnd();
}

function init() {
  dbgGroup("INIT() CALLED");

  run(false);

  if (window.refreshIntervalId) clearInterval(window.refreshIntervalId);

  window.refreshIntervalId = setInterval(() => {
    run(true);
  }, REFRESH_INTERVAL);

  dbgGroupEnd();
}

init();
dbgGroupEnd();
</script>
</body>
</html>
