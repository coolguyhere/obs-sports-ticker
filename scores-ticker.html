<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Sports Ticker</title>

<style>
:root {
  --bar-h: 48px;
  --bg: #111;
  --text: #fff;
  --pill-bg: #1a1a1a;
  --pill-pad: 10px 14px;
  --sep: 18px;
  --round-bg: #222;
  --round-text: #fff;
  --font: 14px;
}

/* Container */
body {
  margin: 0;
  background: #000;
  font-family: Arial, sans-serif;
}

/* Bottom-pinned ticker */
.ticker-wrapper {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 9999;
}

.ticker-bar {
  height: var(--bar-h);
  background: var(--bg);
  overflow: hidden;
  display: flex;
  align-items: center;
  white-space: nowrap;
  border-top: 3px solid #c00; /* default ESPN red stripe */
  transition: border-top 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
}

.rail-viewport {
  overflow: hidden;
  width: 100%;
  height: var(--bar-h);
}

#rail,
#rail-staging {
  display: inline-flex;
  align-items: center;
  height: var(--bar-h);
  will-change: transform;
}

/* Pills */
.pill {
  display: inline-flex;
  align-items: center;
  background: var(--pill-bg);
  color: var(--text);
  padding: var(--pill-pad);
  margin-right: var(--sep);
  border-radius: 4px;
  font-size: var(--font);
  height: calc(var(--bar-h) - 12px);
}

.pill img.logo {
  height: calc(var(--bar-h) * 0.55);
  width: auto;
  margin-right: 8px;
}

/* Header pills */
.header-pill {
  background: var(--round-bg);
  color: var(--round-text);
  font-weight: bold;
  text-transform: uppercase;
}

.header-pill .logo {
  width: calc(var(--bar-h) * 0.45);
  height: auto;
  margin-right: 8px;
}

/* Team logos */
.team-logo {
  height: calc(var(--bar-h) * 0.55);
  width: auto;
  margin: 0 6px;
}

/* Score flash */
.score-flash {
  animation: flash 0.6s ease-out;
}
@keyframes flash {
  0% { color: #fff; }
  50% { color: #ff0; }
  100% { color: #fff; }
}

/* ---------------------------------------------------------
   SUPER BOWL THEME B (Bold)
--------------------------------------------------------- */

/* Gold gradient bar only when SUPER BOWL is active */
.superbowl-bar {
  border-top: 3px solid transparent;
  background: linear-gradient(to right, #111, #111),
              linear-gradient(90deg, #d4af37, #f7e27c, #d4af37);
  background-origin: border-box;
  background-clip: padding-box, border-box;
  box-shadow: 0 0 12px rgba(212,175,55,0.6);
}

/* Super Bowl header pill */
.superbowl-header {
  background: linear-gradient(90deg, #3a3a3a, #4a4a4a, #3a3a3a);
  color: #f7e27c;
  box-shadow: 0 0 10px rgba(212,175,55,0.8);
  animation: sbPulse 2.4s ease-in-out infinite;
  border: 1px solid rgba(212,175,55,0.6);
}

.superbowl-header .logo {
  width: calc(var(--bar-h) * 0.60);
}

/* Pulse animation */
@keyframes sbPulse {
  0% { box-shadow: 0 0 6px rgba(212,175,55,0.4); }
  50% { box-shadow: 0 0 14px rgba(212,175,55,0.9); }
  100% { box-shadow: 0 0 6px rgba(212,175,55,0.4); }
}
</style>
</head>

<body>

<div class="ticker-wrapper">
  <div class="ticker-bar">
    <div class="rail-viewport">
      <div id="rail"></div>
      <div id="rail-staging" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
/* ---------------------------------------------------------
   CONFIG
--------------------------------------------------------- */

const LEAGUES = [
  { name:"NFL", key:"nfl", url:"https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard" },
  { name:"NBA", key:"nba", url:"https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard" },
  { name:"MLB", key:"mlb", url:"https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard" },
  { name:"NHL", key:"nhl", url:"https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard" }
];

const LEAGUE_LOGOS = {
  nfl: "https://a.espncdn.com/i/teamlogos/leagues/500/nfl.png",
  nba: "https://a.espncdn.com/i/teamlogos/leagues/500/nba.png",
  mlb: "https://a.espncdn.com/i/teamlogos/leagues/500/mlb.png",
  nhl: "https://a.espncdn.com/i/teamlogos/leagues/500/nhl.png"
};

const TARGET_LOOP_SECONDS = 36;
const MIN_SPEED = 40;
const MAX_SPEED = 120;

let CACHE = null;
let CACHE_TS = 0;
const CACHE_TTL = 15000;

let pillWidthCache = new WeakMap();
let viewportRectCache = null;

let rail = null;
let railStaging = null;

/* ---------------------------------------------------------
   HELPERS
--------------------------------------------------------- */

function safe(obj, path, fallback="") {
  try {
    return path.split(".").reduce((o,k)=>o[k], obj) ?? fallback;
  } catch {
    return fallback;
  }
}

function pstTimestamp(iso){
  return new Date(iso).getTime();
}

function formatPST(iso){
  const d = new Date(iso);
  return d.toLocaleTimeString("en-US", { hour:"numeric", minute:"2-digit", timeZone:"America/Los_Angeles" });
}

function normalizeRound(raw){
  const t = (raw || "").toUpperCase();
  if(t.includes("WILD")) return "WILD CARD";
  if(t.includes("DIVISION")) return "DIVISIONAL";
  if(t.includes("CHAMP") && !t.includes("SUPER")) return "CONF CHAMPIONSHIP";
  if(t.includes("SUPER")) return "SUPER BOWL";
  return "Regular";
}

function gameState(item){
  if(item.isLive) return 1;
  if(item.statusText.toUpperCase().includes("FINAL")) return 2;
  return 0;
}

function gameSort(a,b){
  return pstTimestamp(a.iso) - pstTimestamp(b.iso);
}

/* ---------------------------------------------------------
   PROXY FETCH
--------------------------------------------------------- */

async function fetchJson(url){
  const proxy = "https://corsproxy.io/?";
  try {
    const r = await fetch(proxy + encodeURIComponent(url), { cache:"no-store" });
    if(r.ok) return r.json();
  } catch(e){
    console.error("Proxy fetch error:", e);
  }
  return null;
}

/* ---------------------------------------------------------
   UNIFIED fetchScores()
--------------------------------------------------------- */

async function fetchScores(){
  const now = Date.now();
  if (CACHE && (now - CACHE_TS) < CACHE_TTL) return CACHE;

  const allItems = [];

  for (const lg of LEAGUES) {
    const leagueKey = lg.key.toLowerCase();
    const playoffGroups = {};
    const regulars = [];

    try {
      const data = await fetchJson(lg.url);
      if (!data) continue;

      const events = (data.events || []).slice();

      for (const ev of events) {

        const seasonType = safe(ev, "season.type", 0);
        if (seasonType !== 2 && seasonType !== 3) continue;

        const comp = safe(ev, "competitions.0", null);
        if (!comp) continue;

        const away = (comp.competitors || []).find(t => t.homeAway === "away");
        const home = (comp.competitors || []).find(t => t.homeAway === "home");
        if (!away || !home) continue;

        const iso = ev.date || comp.date || "";
        if (!iso) continue;

        const ts = pstTimestamp(iso);
        const daysOut = (ts - Date.now()) / 86400000;
        if (daysOut > 30) continue;

        const kickoff = formatPST(iso);

        const status = safe(comp, "status.type", {});
        const state = safe(status, "state", "");
        const isLive = state === "in";
        const statusText = isLive
          ? "LIVE"
          : (safe(status, "shortDetail", "") ||
             safe(status, "type.text", "") ||
             "");

        const awayLogo = safe(away, "team.logo", safe(away, "team.logos.0.href", ""));
        const homeLogo = safe(home, "team.logo", safe(home, "team.logos.0.href", ""));
        const awayAbbr = (safe(away, "team.abbreviation", safe(away, "team.displayName", "")) || "").toUpperCase();
        const homeAbbr = (safe(home, "team.abbreviation", safe(home, "team.displayName", "")) || "").toUpperCase();
        const awayScore = safe(away, "score", "");
        const homeScore = safe(home, "score", "");

        const isPlayoff = seasonType === 3;
        const roundRaw = safe(comp, "notes.0.headline", safe(ev, "league.name", "Playoffs"));
        const round = normalizeRound(roundRaw);

        const item = {
          league: lg.name,
          leagueKey,
          isPlayoff,
          round,
          iso,
          kickoff,
          networks: [],
          away: { abbr: awayAbbr, logo: awayLogo, score: awayScore },
          home: { abbr: homeAbbr, logo: homeLogo, score: homeScore },
          isLive,
          statusText
        };

        if (isPlayoff) {
          playoffGroups[round] = playoffGroups[round] || [];
          playoffGroups[round].push(item);
        } else {
          regulars.push(item);
        }
      }

      const leagueItems = [];

      const rounds = Object.keys(playoffGroups).sort();
      for (const r of rounds) {
        const arr = playoffGroups[r].slice().sort(gameSort);
        if (arr.length) {
          leagueItems.push({ type: "roundHeader", header: r, leagueKey });
          leagueItems.push(...arr);
        }
      }

      const regularSorted = regulars.slice().sort(gameSort);
      if (regularSorted.length) {
        leagueItems.push({ type: "roundHeader", header: "Regular", leagueKey });
        leagueItems.push(...regularSorted);
      }

      allItems.push(...leagueItems);

    } catch (err) {
      console.error("League fetch error", lg.name, err);
    }
  }

  const seen = new Set();
  const dedup = [];

  for (const it of allItems) {
    if (it.type === "roundHeader") {
      dedup.push(it);
      continue;
    }
    const key = `${it.iso}|${it.away.abbr}|${it.home.abbr}|${it.league}`;
    if (!seen.has(key)) {
      seen.add(key);
      dedup.push(it);
    }
  }

  CACHE = dedup;
  CACHE_TS = Date.now();
  return dedup;
}

/* ---------------------------------------------------------
   RENDERING
--------------------------------------------------------- */

function createHeaderPill(text, leagueKey){
  const pill = document.createElement("span");
  pill.className = "pill header-pill";

  const logo = document.createElement("img");
  logo.className = "logo";
  logo.src = LEAGUE_LOGOS[leagueKey] || "";
  logo.alt = leagueKey.toUpperCase();
  logo.onerror = () => logo.hidden = true;

  const label = document.createElement("span");
  label.textContent = text;

  pill.appendChild(logo);
  pill.appendChild(label);

  if (text === "SUPER BOWL") {
    pill.classList.add("superbowl-header");
  }

  return pill;
}

function createGamePill(item){
  const pill = document.createElement("span");
  pill.className = "pill";

  const awayLogo = document.createElement("img");
  awayLogo.className = "team-logo";
  awayLogo.src = item.away.logo;
  awayLogo.onerror = () => awayLogo.hidden = true;

  const homeLogo = document.createElement("img");
  homeLogo.className = "team-logo";
  homeLogo.src = item.home.logo;
  homeLogo.onerror = () => homeLogo.hidden = true;

  const away = document.createElement("span");
  away.textContent = item.away.abbr;

  const home = document.createElement("span");
  home.textContent = item.home.abbr;

  const score = document.createElement("span");
  score.style.margin = "0 8px";

  const state = gameState(item);
  if (state === 0) {
    score.textContent = item.kickoff;
  } else if (state === 1) {
    score.textContent = `${item.away.score} - ${item.home.score} LIVE`;
  } else {
    score.textContent = `${item.away.score} - ${item.home.score} FINAL`;
  }

  pill.appendChild(awayLogo);
  pill.appendChild(away);
  pill.appendChild(score);
  pill.appendChild(home);
  pill.appendChild(homeLogo);

  return pill;
}

/* ---------------------------------------------------------
   BUILD RAILS
--------------------------------------------------------- */

function buildRailInto(container, items){
  container.innerHTML = "";

  let isSuperBowl = false;

  for (const it of items) {
    if (it.type === "roundHeader") {
      if (it.header === "SUPER BOWL") {
        isSuperBowl = true;
      }
      container.appendChild(createHeaderPill(it.header, it.leagueKey));
    } else {
      container.appendChild(createGamePill(it));
    }
  }

  return isSuperBowl;
}

function applySuperBowlTheme(isSuperBowl){
  const bar = document.querySelector(".ticker-bar");
  bar.classList.toggle("superbowl-bar", isSuperBowl);
}

/* ---------------------------------------------------------
   LOOP ENGINE
--------------------------------------------------------- */

let x = 0;
let lastTs = null;
let smoothedFps = 60;
let lastFpsTs = performance.now();

function computeDynamicSpeed(){
  return rail.scrollWidth / TARGET_LOOP_SECONDS;
}

function loopFrame(ts){
  if (!lastTs) lastTs = ts;
  const dt = (ts - lastTs) / 1000;
  lastTs = ts;

  const frameTime = ts - lastFpsTs;
  lastFpsTs = ts;
  const currentFps = 1000 / frameTime;
  smoothedFps = smoothedFps * 0.9 + currentFps * 0.1;

  let dynamicSpeed = computeDynamicSpeed();
  dynamicSpeed = Math.max(MIN_SPEED, Math.min(MAX_SPEED, dynamicSpeed));

  x -= dynamicSpeed * dt;
  rail.style.transform = `translateX(${x}px)`;

  const viewport = document.querySelector(".rail-viewport");
  const vpRect = viewportRectCache || viewport.getBoundingClientRect();
  viewportRectCache = vpRect;

  const first = rail.firstElementChild;

  if (first) {
    let width = pillWidthCache.get(first);
    if (!width) {
      width = first.getBoundingClientRect().width;
      pillWidthCache.set(first, width);
    }

    const firstRect = first.getBoundingClientRect();

    if (firstRect.right < vpRect.left) {
      rail.appendChild(first);
      x += width;
      rail.style.transform = `translateX(${x}px)`;
    }
  }

  viewportRectCache = null;

  requestAnimationFrame(loopFrame);
}

/* ---------------------------------------------------------
   REFRESH WITHOUT HICCUP (STAGING + SWAP)
--------------------------------------------------------- */

async function refreshData(){
  const items = await fetchScores();
  if (!items || !items.length) return;

  // Build into staging rail off-screen
  const isSuperBowl = buildRailInto(railStaging, items);

  // Atomic swap between frames
  requestAnimationFrame(() => {
    // Preserve current offset relative to new content
    const oldRail = rail;
    const oldWidth = oldRail.scrollWidth || 1;
    const oldX = x;

    rail = railStaging;
    railStaging = oldRail;

    // Put staging off-screen again
    railStaging.style.display = "none";
    rail.style.display = "inline-flex";

    // Reset caches for new nodes
    pillWidthCache = new WeakMap();
    viewportRectCache = null;

    // Adjust x proportionally to new width to avoid jumps
    const newWidth = rail.scrollWidth || 1;
    const ratio = newWidth / oldWidth;
    x = oldX * ratio;
    rail.style.transform = `translateX(${x}px)`;

    applySuperBowlTheme(isSuperBowl);
  });
}

/* ---------------------------------------------------------
   BOOTSTRAP
--------------------------------------------------------- */

async function bootstrapTicker(){
  rail = document.getElementById("rail");
  railStaging = document.getElementById("rail-staging");

  const items = await fetchScores();
  if (!items || !items.length) return;

  const isSuperBowl = buildRailInto(rail, items);
  applySuperBowlTheme(isSuperBowl);

  requestAnimationFrame(loopFrame);

  setInterval(refreshData, 15000);
}

bootstrapTicker();
</script>

</body>
</html>
